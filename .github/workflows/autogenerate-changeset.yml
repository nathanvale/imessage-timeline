name: Auto-generate Changeset (PR)

on:
  pull_request:
    types: [opened, synchronize, edited, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Detect existing changeset
        id: detect
        run: |
          COUNT=$(ls .changeset/*.md 2>/dev/null | wc -l | tr -d ' ' || true)
          echo "found=$COUNT" >> $GITHUB_OUTPUT
      - name: Setup pnpm toolchain
        uses: ./.github/actions/setup-pnpm
      - name: Install deps (minimal)
        run: pnpm install --frozen-lockfile --ignore-scripts
      - name: Generate changeset if missing
        if: steps.detect.outputs.found == '0'
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          LOWER=$(echo "$TITLE" | tr 'A-Z' 'a-z')
          TYPE=patch
          if echo "$LOWER" | grep -q '^feat'; then TYPE=minor; fi
          if echo "$LOWER" | grep -q 'breaking'; then TYPE=major; fi
          SAFE_NAME=$(echo "$TITLE" | tr -cd '[:alnum:] -' | tr ' ' '-')
          FILE=".changeset/auto-${SAFE_NAME:-change}.md"
          echo "---" > "$FILE"
          echo "imessage-timeline: $TYPE" >> "$FILE"
          echo "---" >> "$FILE"
          echo >> "$FILE"
          echo "$TITLE" >> "$FILE"
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$FILE"
          git commit -m "chore(changeset): auto-generate for PR #${{ github.event.pull_request.number }}" || echo 'No commit'
          git push || echo 'Push skipped'
      - name: Annotate PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const missing = '${{ steps.detect.outputs.found }}' === '0'
            const body = missing ? 'Auto-generated a changeset for this PR.' : 'Changeset already present.'
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            })
