name: Auto-generate Changeset (PR)

on:
  pull_request:
    types: [opened, synchronize, edited, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Detect existing changeset
        id: detect
        shell: bash
        run: |
          set -eu
          # Count files safely; allow directory to be absent. Use NUL delimiters.
          COUNT=0
          while IFS= read -r -d '' _file; do
            COUNT=$((COUNT + 1))
          done < <(find .changeset -type f -name '*.md' -print0 2>/dev/null)
          COUNT="${COUNT//[[:space:]]/}"
          echo "found=$COUNT" >> "$GITHUB_OUTPUT"
      - name: Setup pnpm toolchain
        uses: ./.github/actions/setup-pnpm
      - name: Install deps (minimal)
        run: pnpm install --frozen-lockfile --ignore-scripts
      - name: Generate changeset if missing
        if: steps.detect.outputs.found == '0'
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -eu
          # string assignment from env is intentional
          # shellcheck disable=SC2209
          TITLE="${PR_TITLE:-}"
          # Lowercase title using tr to avoid shell-specific expansions that trigger shellcheck
          LOWER="$(printf '%s' "$TITLE" | tr '[:upper:]' '[:lower:]')"
          TYPE=patch
          if printf '%s' "$LOWER" | grep -q '^feat'; then TYPE=minor; fi
          if printf '%s' "$LOWER" | grep -q 'breaking'; then TYPE=major; fi
          # Sanitize: keep alnum, space, hyphen; then convert spaces to hyphens
          SAFE_NAME="$(printf '%s' "$TITLE" | sed -E 's/[^[:alnum:][:space:]-]//g' | tr ' ' '-')"
          FILE=".changeset/auto-${SAFE_NAME:-change}.md"
          {
            printf '---\n'
            printf 'imessage-timeline: %s\n' "$TYPE"
            printf '---\n\n'
            printf '%s\n' "$TITLE"
          } > "$FILE"
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$FILE"
          git commit -m "chore(changeset): auto-generate for PR #$PR_NUMBER" || echo 'No commit'
          git push || echo 'Push skipped'
      - name: Annotate PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const missing = '${{ steps.detect.outputs.found }}' === '0'
            const body = missing ? 'Auto-generated a changeset for this PR.' : 'Changeset already present.'
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            })
