name: Alpha Snapshot Release

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 02:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  snapshot-alpha:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: alpha-snapshot-${{ github.ref }}
      # Prevent mid-publish cancellation to avoid inconsistent npm state
      cancel-in-progress: false
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Check pre-mode active
        id: pre
        shell: bash
        run: |
          set -euo pipefail
          if [ -f .changeset/pre.json ]; then
            echo "active=true" >> "$GITHUB_OUTPUT"
          else
            echo "active=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Skip when pre-mode is not active
        if: steps.pre.outputs.active == 'false'
        run: echo "Pre-mode not active; skipping alpha snapshot." && exit 0
      - name: Standard CI Env
        uses: ./.github/actions/standard-ci-env
      - name: Setup pnpm toolchain
        uses: ./.github/actions/setup-pnpm
      - name: Install dependencies
        if: steps.pre.outputs.active == 'true'
        run: pnpm install --frozen-lockfile
      - name: Alpha snapshot version + publish
        if: steps.pre.outputs.active == 'true'
        shell: bash
        run: ./.github/scripts/alpha-snapshot-publish.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
