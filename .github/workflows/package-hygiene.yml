name: Package Hygiene

on:
  workflow_dispatch: {}
  push:
    branches: [main]
  pull_request:
    paths:
      - 'package.json'
      - 'src/**'
      - 'tsconfig.*'
      - '.github/workflows/package-hygiene.yml'

permissions:
  contents: read
  actions: read

jobs:
  hygiene:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: .nvmrc
      - name: Enable Corepack (pnpm)
        run: corepack enable
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          run_install: false
      - name: Get pnpm store path
        id: pnpm-store
        run: echo "PNPM_STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Cache pnpm store
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('.nvmrc') }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-${{ hashFiles('.nvmrc') }}-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
      - name: Publint (package structure lint)
        run: pnpm check:publint
      - name: Types validation (are-the-types-wrong)
        continue-on-error: true
        run: pnpm check:types
      - name: Dry pack & artifact
        run: pnpm pack:dry
      - name: Upload packed artifact
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: package-tarball
          path: ./.pack/*.tgz
          retention-days: 14
