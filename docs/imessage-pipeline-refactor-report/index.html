<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-imessage-pipeline-refactor-report" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">iMessage pipeline refactor report | iMessage Timeline</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nathanvale.github.io/imessage-timeline/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://nathanvale.github.io/imessage-timeline/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://nathanvale.github.io/imessage-timeline/docs/imessage-pipeline-refactor-report"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="iMessage pipeline refactor report | iMessage Timeline"><meta data-rh="true" name="description" content="A comprehensive review and refactor plan to separate ingestion, normalization,"><meta data-rh="true" property="og:description" content="A comprehensive review and refactor plan to separate ingestion, normalization,"><link data-rh="true" rel="icon" href="/imessage-timeline/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://nathanvale.github.io/imessage-timeline/docs/imessage-pipeline-refactor-report"><link data-rh="true" rel="alternate" href="https://nathanvale.github.io/imessage-timeline/docs/imessage-pipeline-refactor-report" hreflang="en"><link data-rh="true" rel="alternate" href="https://nathanvale.github.io/imessage-timeline/docs/imessage-pipeline-refactor-report" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"iMessage pipeline refactor report","item":"https://nathanvale.github.io/imessage-timeline/docs/imessage-pipeline-refactor-report"}]}</script><link rel="alternate" type="application/rss+xml" href="/imessage-timeline/blog/rss.xml" title="iMessage Timeline RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/imessage-timeline/blog/atom.xml" title="iMessage Timeline Atom Feed"><link rel="stylesheet" href="/imessage-timeline/assets/css/styles.38614e9a.css">
<script src="/imessage-timeline/assets/js/runtime~main.da1a3075.js" defer="defer"></script>
<script src="/imessage-timeline/assets/js/main.aab6d5fc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/imessage-timeline/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_RfLI" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/imessage-timeline/"><div class="navbar__logo"><img src="/imessage-timeline/img/logo.svg" alt="iMessage Timeline Logo" class="themedComponent_dXTd themedComponent--light_iTBJ"><img src="/imessage-timeline/img/logo.svg" alt="iMessage Timeline Logo" class="themedComponent_dXTd themedComponent--dark_hPpa"></div><b class="navbar__title text--truncate">iMessage Timeline</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/imessage-timeline/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/imessage-timeline/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/nathanvale/imessage-timeline" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_h_1J"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_CCJv colorModeToggle_zjfh"><button class="clean-btn toggleButton_ghGq toggleButtonDisabled_YNiD" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_V3Nl lightToggleIcon_ZJcu"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_V3Nl darkToggleIcon_XA2Y"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_V3Nl systemToggleIcon_olV9"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_GVyH"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_dlcL"><div class="docsWrapper_JyLI"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sZOX" type="button"></button><div class="docRoot_utHZ"><aside class="theme-doc-sidebar-container docSidebarContainer_evXk"><div class="sidebarViewport_Gbc4"><div class="sidebar_hMr3"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_whOC"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/intro"><span title="Introduction" class="linkLabel_ZnI_">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/cli-usage"><span title="CLI" class="linkLabel_ZnI_">CLI</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/MONOREPO_RECOMMENDATIONS"><span title="Monorepo &amp; Documentation Strategy Recommendations" class="linkLabel_ZnI_">Monorepo &amp; Documentation Strategy Recommendations</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/actionlint-best-practices"><span title="actionlint best practices" class="linkLabel_ZnI_">actionlint best practices</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/actionlint-quickstart"><span title="actionlint quickstart" class="linkLabel_ZnI_">actionlint quickstart</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/automated-release-workflow"><span title="Automated Release Workflow" class="linkLabel_ZnI_">Automated Release Workflow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/branch-protection-policy"><span title="Branch Protection Policy (proposed)" class="linkLabel_ZnI_">Branch Protection Policy (proposed)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/bun-hybrid-implementation-checklist"><span title="Bun Hybrid Implementation Checklist" class="linkLabel_ZnI_">Bun Hybrid Implementation Checklist</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/bun-script-best-practices"><span title="Bun script best practices (CLI-focused)" class="linkLabel_ZnI_">Bun script best practices (CLI-focused)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/bun-single-repo-best-practices"><span title="bun-single-repo-best-practices" class="linkLabel_ZnI_">bun-single-repo-best-practices</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/ci-pnpm-caching"><span title="CI pnpm Caching Strategy" class="linkLabel_ZnI_">CI pnpm Caching Strategy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/ci-workflow-standards"><span title="CI workflow standards" class="linkLabel_ZnI_">CI workflow standards</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/config-best-practices-review"><span title="config-best-practices-review" class="linkLabel_ZnI_">config-best-practices-review</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/dependency-maintenance"><span title="dependency-maintenance" class="linkLabel_ZnI_">dependency-maintenance</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pXRd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/imessage-timeline/docs/diagrams/pre-mode-workflow-simple"><span title="diagrams" class="categoryLinkLabel_hinY">diagrams</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/dual-mode-distribution-best-practices"><span title="Dual-Mode Distribution Best Practices" class="linkLabel_ZnI_">Dual-Mode Distribution Best Practices</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/emergency-rollback-procedure"><span title="Emergency Rollback Procedure" class="linkLabel_ZnI_">Emergency Rollback Procedure</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-enhancements-spec"><span title="iMessage Pipeline Enhancements Specification" class="linkLabel_ZnI_">iMessage Pipeline Enhancements Specification</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-implementation-summary"><span title="iMessage Pipeline Implementation Summary" class="linkLabel_ZnI_">iMessage Pipeline Implementation Summary</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/imessage-timeline/docs/imessage-pipeline-refactor-report"><span title="iMessage pipeline refactor report" class="linkLabel_ZnI_">iMessage pipeline refactor report</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-tasks"><span title="iMessage Pipeline Implementation Tasks" class="linkLabel_ZnI_">iMessage Pipeline Implementation Tasks</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-tech-spec"><span title="iMessage pipeline — technical specification" class="linkLabel_ZnI_">iMessage pipeline — technical specification</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-troubleshooting"><span title="iMessage Pipeline Troubleshooting Guide" class="linkLabel_ZnI_">iMessage Pipeline Troubleshooting Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/imessage-pipeline-usage"><span title="iMessage Pipeline Usage Guide" class="linkLabel_ZnI_">iMessage Pipeline Usage Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/logging"><span title="Logging and sinks" class="linkLabel_ZnI_">Logging and sinks</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/npm-automation-token-setup"><span title="NPM Automation Token Setup Guide" class="linkLabel_ZnI_">NPM Automation Token Setup Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/package-hygiene"><span title="Package Hygiene &amp; Metadata Quality" class="linkLabel_ZnI_">Package Hygiene &amp; Metadata Quality</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/pre-mode-consolidation-plan"><span title="Pre-Mode Workflow Consolidation Plan" class="linkLabel_ZnI_">Pre-Mode Workflow Consolidation Plan</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/pre-release-guide"><span title="Pre-Release Guide - Canary, Beta, and RC Releases" class="linkLabel_ZnI_">Pre-Release Guide - Canary, Beta, and RC Releases</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/prettier-best-practices"><span title="Prettier Best Practices &amp; Formatting Strategy" class="linkLabel_ZnI_">Prettier Best Practices &amp; Formatting Strategy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/release-channels"><span title="Release Channels &amp; Prerelease Strategy" class="linkLabel_ZnI_">Release Channels &amp; Prerelease Strategy</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pXRd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/imessage-timeline/docs/releases/changesets-canonical"><span title="releases" class="categoryLinkLabel_hinY">releases</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/sbom-generation-review"><span title="SBOM Generation Review" class="linkLabel_ZnI_">SBOM Generation Review</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/security-supply-chain"><span title="security-supply-chain" class="linkLabel_ZnI_">security-supply-chain</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/test-configuration-research"><span title="Test Configuration Best Practices Research" class="linkLabel_ZnI_">Test Configuration Best Practices Research</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/testing-best-practices"><span title="Testing best practices (Vitest + Testing Library + Wallaby)" class="linkLabel_ZnI_">Testing best practices (Vitest + Testing Library + Wallaby)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/imessage-timeline/docs/vitest-firecrawl-esm-bun-best-practices"><span title="Vitest + Firecrawl ESM &amp; Bun Best Practices for CLI Projects" class="linkLabel_ZnI_">Vitest + Firecrawl ESM &amp; Bun Best Practices for CLI Projects</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_nkwQ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_wBRg"><div class="docItemContainer_GvXy"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_n25q" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/imessage-timeline/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_Ebew"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">iMessage pipeline refactor report</span></li></ul></nav><div class="tocCollapsible_twB_ theme-doc-toc-mobile tocMobile_BZyV"><button type="button" class="clean-btn tocCollapsibleButton_HJWU">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>iMessage pipeline refactor report</h1></header>
<blockquote>
<p>A comprehensive review and refactor plan to separate ingestion, normalization,
AI enrichment, and markdown rendering for deterministic, resumable, and
testable workflows.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="executive-summary">executive summary<a href="#executive-summary" class="hash-link" aria-label="Direct link to executive summary" title="Direct link to executive summary" translate="no">​</a></h2>
<p>You currently have three scripts:</p>
<ul>
<li class=""><code>.scripts/convert-csv-to-json.mjs</code> — Ingests legacy iMazing CSV and produces a
detailed JSON with attachment resolution, tapback/reply parsing, and some
linking logic</li>
<li class=""><code>.scripts/export-imessages-json.mjs</code> — Exports new messages directly from the
Messages.app SQLite DB into a comprehensive JSON format, including attachments
and tapback metadata</li>
<li class=""><code>.scripts/analyze-messages-json.mjs</code> — Processes a JSON export, enriches
images/audio/links using external APIs, and also generates daily markdown</li>
</ul>
<p>Key issues today:</p>
<ul>
<li class="">Responsibilities overlap and couple concerns (analysis + markdown rendering in
a single tool)</li>
<li class="">No single source of truth for the schema across scripts</li>
<li class="">Linking, deduplication, and ID stability are not centralized</li>
<li class="">Enrichment is tightly bound to rendering, making it harder to run
independently and to resume</li>
</ul>
<p>Refactor goal:</p>
<ul>
<li class="">Four clear stages: ingest → normalize/link → enrich (AI) → render (markdown)</li>
<li class="">One unified, versioned JSON schema (with Zod validation and TypeScript types)</li>
<li class="">Idempotent, checkpointable enrichment stage that only augments data</li>
<li class="">Deterministic markdown rendering that consumes enriched JSON only</li>
</ul>
<p>The plan below details the target architecture, unified schema, linking/dedup
strategy, file layout, test/CI setup with Vitest, migration steps, and a rollout
checklist.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="target-architecture-four-stage-pipeline">target architecture (four-stage pipeline)<a href="#target-architecture-four-stage-pipeline" class="hash-link" aria-label="Direct link to target architecture (four-stage pipeline)" title="Direct link to target architecture (four-stage pipeline)" translate="no">​</a></h2>
<div class="language-mermaid codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-mermaid codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token plain">flowchart LR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  A[Ingest: CSV] --&gt; C[Normalize/Link]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  B[Ingest: DB]  --&gt; C[Normalize/Link]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  C --&gt; D[Enrich: AI]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  D --&gt; E[Render: Markdown]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph inputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph outputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="stage-1--ingest">stage 1 — ingest<a href="#stage-1--ingest" class="hash-link" aria-label="Direct link to stage 1 — ingest" title="Direct link to stage 1 — ingest" translate="no">​</a></h3>
<ul>
<li class="">Tools<!-- -->
<ul>
<li class=""><code>ingest-csv</code> (refactor from <code>convert-csv-to-json.mjs</code>)</li>
<li class=""><code>ingest-db</code> (refactor from <code>export-imessages-json.mjs</code>)</li>
</ul>
</li>
<li class="">Output<!-- -->
<ul>
<li class="">Raw JSON artifacts with consistent base fields and minimal transformation</li>
<li class="">Do not perform cross-message linking or enrichment here</li>
</ul>
</li>
<li class="">Notes<!-- -->
<ul>
<li class="">Keep the media file path resolution you already built (it’s valuable and
hard to reproduce later)</li>
<li class="">Normalize field names where possible but avoid introducing derived fields
that depend on cross-message context</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="stage-2--normalize--link">stage 2 — normalize &amp; link<a href="#stage-2--normalize--link" class="hash-link" aria-label="Direct link to stage 2 — normalize &amp; link" title="Direct link to stage 2 — normalize &amp; link" translate="no">​</a></h3>
<ul>
<li class="">Tool: <code>normalize-link</code></li>
<li class="">Responsibilities<!-- -->
<ul>
<li class="">Merge multiple ingests (CSV and DB) into a single coherent dataset</li>
<li class="">Deduplicate messages across sources</li>
<li class="">Link replies and tapbacks deterministically</li>
<li class="">Compute stable, canonical IDs per message, per part</li>
<li class="">Enforce and validate schema via Zod</li>
</ul>
</li>
<li class="">Output<!-- -->
<ul>
<li class=""><code>messages.normalized.json</code> — The single source of truth for subsequent
stages</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="stage-3--enrich-ai-only">stage 3 — enrich (AI only)<a href="#stage-3--enrich-ai-only" class="hash-link" aria-label="Direct link to stage 3 — enrich (AI only)" title="Direct link to stage 3 — enrich (AI only)" translate="no">​</a></h3>
<ul>
<li class="">Tool: <code>enrich-ai</code></li>
<li class="">Responsibilities<!-- -->
<ul>
<li class="">Image analysis (Gemini Vision)</li>
<li class="">Audio transcription</li>
<li class="">Link context extraction (Firecrawl)</li>
<li class="">Append results to <code>message.media.enrichment</code></li>
<li class="">Strict rate-limiting, retries, checkpointing, and resumability</li>
<li class="">Pure augmentation: must not alter core identifiers or linking state</li>
</ul>
</li>
<li class="">Output<!-- -->
<ul>
<li class=""><code>messages.enriched.json</code> — Preserves original data + adds <code>enrichment</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="stage-4--render-markdown-only">stage 4 — render (markdown only)<a href="#stage-4--render-markdown-only" class="hash-link" aria-label="Direct link to stage 4 — render (markdown only)" title="Direct link to stage 4 — render (markdown only)" translate="no">​</a></h3>
<ul>
<li class="">Tool: <code>render-markdown</code></li>
<li class="">Responsibilities<!-- -->
<ul>
<li class="">Convert enriched JSON to deterministic daily markdown</li>
<li class="">Zero network calls, zero enrichment logic</li>
</ul>
</li>
<li class="">Output<!-- -->
<ul>
<li class="">Daily markdown files under your chosen <code>outputDir</code></li>
</ul>
</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="what-the-current-analyzer-already-does-well-to-preserve">what the current analyzer already does well (to preserve)<a href="#what-the-current-analyzer-already-does-well-to-preserve" class="hash-link" aria-label="Direct link to what the current analyzer already does well (to preserve)" title="Direct link to what the current analyzer already does well (to preserve)" translate="no">​</a></h2>
<p>Your existing <code>.scripts/analyze-messages-json.mjs</code> has a lot of thoughtful
features we want to keep as we split it into <code>enrich-ai</code> and <code>render-markdown</code>:</p>
<ul>
<li class="">Audio transcription that is actually useful<!-- -->
<ul>
<li class="">Uses Gemini with a structured prompt that first classifies the audio (voice
memo, conversation, music, ambient) and then transcribes with timestamps,
speaker labels, and emotive cues</li>
<li class="">Returns a full transcription plus a concise short description</li>
</ul>
</li>
<li class="">Image analysis with smart preprocessing<!-- -->
<ul>
<li class="">Converts HEIC/TIFF/GIF to JPG via <code>sips</code> for analysis and also generates a
JPG preview for Obsidian embedding</li>
<li class="">Produces a thorough description plus a short, scannable caption</li>
</ul>
</li>
<li class="">PDF analysis and pragmatic video handling<!-- -->
<ul>
<li class="">Summarizes PDFs with Gemini when enabled</li>
<li class="">Skips heavy video analysis by default for performance but still copies and
surfaces the file</li>
</ul>
</li>
<li class="">Link context enrichment with resilient fallbacks<!-- -->
<ul>
<li class="">Firecrawl scraping to Markdown first, then a smart title extraction</li>
<li class="">Site-aware fallbacks: YouTube oEmbed or ID detection, Spotify/Facebook/
Instagram heuristics, and a safe generic fallback</li>
</ul>
</li>
<li class="">MIME-driven item typing, not just extensions<!-- -->
<ul>
<li class="">Uses MIME to determine image/audio/video/pdf and pick the right enrichment
path</li>
</ul>
</li>
<li class="">Reliable file handling and naming<!-- -->
<ul>
<li class="">Absolute paths are resolved up front; destination files use timestamped
names sanitized for Obsidian</li>
<li class="">Verifies destination matches source by file size and re-copies on mismatch</li>
<li class="">Creates image previews for HEIC/TIFF and uses Obsidian wikilinks for embeds</li>
</ul>
</li>
<li class="">Checkpointing, progress, and resumability<!-- -->
<ul>
<li class="">Periodic checkpoints with partial enriched JSON and full descriptions, plus
stats, ETA, average time per message, and a failed-items log</li>
<li class="">Flags for <code>--resume</code>, <code>--dry-run</code>, <code>--limit</code>, and <code>--clear-checkpoint</code></li>
</ul>
</li>
<li class="">Sensible rate limiting and backoff points<!-- -->
<ul>
<li class="">Central <code>rateLimitedDelay</code> gate between API calls</li>
<li class="">Configurable delay, model, and retry ceiling</li>
</ul>
</li>
<li class="">Markdown output that reads like a conversation<!-- -->
<ul>
<li class="">Groups by Morning/Afternoon/Evening, sorts by timestamp, and adds message
anchors for deep linking</li>
<li class="">Nests replies/tapbacks beneath the parent, renders tapbacks with emoji, and
quotes voice memo transcriptions nicely</li>
<li class="">Displays link context below each URL in blockquotes</li>
</ul>
</li>
<li class="">Data hygiene that improves readability<!-- -->
<ul>
<li class="">Cleans message text and reply-to snippets, skips unsent markers, and
normalizes whitespace/newlines</li>
</ul>
</li>
<li class="">Practical configuration ergonomics<!-- -->
<ul>
<li class="">JSON config supports env var expansion (e.g., <code>${GEMINI_API_KEY}</code>)</li>
<li class="">Feature toggles: <code>enableVisionAnalysis</code> (images/audio/PDFs) and
<code>enableLinkAnalysis</code> (links)</li>
<li class="">Date filters (<code>startDate</code>, <code>endDate</code>) applied before enrichment</li>
</ul>
</li>
</ul>
<p>How this maps to the refactor:</p>
<ul>
<li class="">Move all networked enrichment (Gemini, Firecrawl) and media copying/preview
generation into <code>enrich-ai</code></li>
<li class="">Keep Obsidian-friendly filenames, preview creation, and MIME-aware routing
exactly as-is, with the same or stricter path invariants</li>
<li class="">Preserve checkpoints and stats in <code>enrich-ai</code> (single checkpoint file,
resumable runs, ETA and averages)</li>
<li class="">Move all markdown-specific layout into <code>render-markdown</code> and keep the same
presentation: time-of-day sections, anchors, nested replies/tapbacks,
blockquoted link context and transcriptions</li>
<li class="">Maintain feature toggles and environment expansion in a unified config, with
renderer options separated from enrichment options</li>
</ul>
<p>Net effect: you keep the transcription quality, image/PDF summaries, robust link
context, safe file handling, and readable markdown—just separated into focused
stages that are easier to test and resume.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="unified-json-schema-typescript--zod">unified JSON schema (TypeScript + Zod)<a href="#unified-json-schema-typescript--zod" class="hash-link" aria-label="Direct link to unified JSON schema (TypeScript + Zod)" title="Direct link to unified JSON schema (TypeScript + Zod)" translate="no">​</a></h2>
<p>Single source of truth for the data model. Typescript provides developer
ergonomics; Zod provides runtime validation and safe parsing.</p>
<p>Important domain adjustment per requirements:</p>
<ul>
<li class="">There is no separate Attachment entity. Media is a standalone message that can
receive replies and tapbacks just like text.</li>
<li class="">Therefore, a message can be one of: text, media, tapback, notification.</li>
<li class="">Media messages carry their own media metadata and enrichment.</li>
</ul>
<div class="language-ts codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-ts codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// src/schema/message.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> z </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;zod&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">MessageGUID</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ChatId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">TapbackInfo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;loved&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;liked&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;disliked&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;laughed&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;emphasized&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;questioned&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;emoji&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;added&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;removed&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessageGuid</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MessageGUID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessagePart</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetText</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isMedia</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  emoji</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ReplyInfo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sender</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ISO 8601</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  text</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessageGuid</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MessageGUID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">MediaKind</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;audio&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;video&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pdf&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;unknown&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">MediaEnrichment</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MediaKind </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;link&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  visionSummary</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shortDescription</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// audio</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transcript</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// link</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  title</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  summary</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// provenance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gemini&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;firecrawl&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;local&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">MediaMeta</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Represents the single media item carried by a media message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  size</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mimeType</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uti</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isSticker</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hidden</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mediaKind</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MediaKind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enrichment</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">MediaEnrichment</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">MessageCore</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  guid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MessageGUID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rowid</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chatId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ChatId </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subject</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destinationCallerId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isFromMe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  otherHandle</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ISO 8601</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateRead</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateDelivered</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateEdited</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isRead</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  itemType</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupActionType</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupTitle</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shareStatus</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shareDirection</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expressiveSendStyleId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  balloonBundleId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  threadOriginatorGuid</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  threadOriginatorPart</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  numReplies</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deletedFrom</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Message</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">MessageCore</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  messageKind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;text&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;notification&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  text</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tapback</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TapbackInfo </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replyingTo</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReplyInfo </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replyingToRaw</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Media is modeled as a message; when messageKind = &#x27;media&#x27;, this is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  media</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MediaMeta </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupGuid</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exportTimestamp</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exportVersion</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isUnsent</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isEdited</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ExportEnvelope</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schemaVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;csv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;merged&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  messages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  meta</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Zod schemas ensure runtime correctness and cross-field invariants</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> TapbackInfoSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;loved&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;liked&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;disliked&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;laughed&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;emphasized&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;questioned&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;emoji&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;added&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;removed&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessageGuid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessagePart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetText</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isMedia</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  emoji</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ReplyInfoSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sender</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetMessageGuid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> AttachmentEnrichmentSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;audio&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;link&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;video&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pdf&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  visionSummary</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shortDescription</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transcript</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">url</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  summary</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;gemini&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;firecrawl&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;local&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MediaEnrichmentSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AttachmentEnrichmentSchema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MediaMetaSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  size</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mimeType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uti</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isSticker</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hidden</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mediaKind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;audio&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;video&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pdf&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;unknown&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enrichment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MediaEnrichmentSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MessageCoreSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  guid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rowid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chatId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destinationCallerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isFromMe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  otherHandle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateRead</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateDelivered</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dateEdited</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isRead</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  itemType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupActionType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupTitle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shareStatus</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shareDirection</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expressiveSendStyleId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  balloonBundleId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  threadOriginatorGuid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  threadOriginatorPart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  numReplies</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deletedFrom</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MessageSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MessageCoreSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  messageKind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;text&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;notification&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tapback</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TapbackInfoSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replyingTo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReplyInfoSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replyingToRaw</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  media</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MediaMetaSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groupGuid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exportTimestamp</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exportVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isUnsent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isEdited</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">boolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">superRefine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Invariants across fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tapback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssueCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">custom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback kind requires tapback payload&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">media</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssueCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">custom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media kind requires media payload&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">media</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssueCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">custom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media payload present on non-media message&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replyingTo</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">date </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isNaN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replyingTo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssueCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">custom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;replyingTo.date must be ISO 8601&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ExportEnvelopeSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schemaVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;csv&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;merged&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  messages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MessageSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  meta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">any</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="schema-notes">schema notes<a href="#schema-notes" class="hash-link" aria-label="Direct link to schema notes" title="Direct link to schema notes" translate="no">​</a></h3>
<ul>
<li class="">Use <code>Array&lt;T&gt;</code> in types to maintain clarity</li>
<li class=""><code>superRefine</code> centralizes cross-field invariants and error messages</li>
<li class="">Media is modeled as a message; keep enrichment under
<code>message.media.enrichment</code></li>
<li class="">Version the <code>schemaVersion</code> and <code>exportVersion</code> so you can orchestrate
migrations predictably</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="csv-output-compatibility--mapping">CSV output compatibility &amp; mapping<a href="#csv-output-compatibility--mapping" class="hash-link" aria-label="Direct link to CSV output compatibility &amp; mapping" title="Direct link to CSV output compatibility &amp; mapping" translate="no">​</a></h2>
<p>Your CSV → JSON converter already splits rows into multiple messages per moment
and models a single media item as its own message with <code>message_kind = &#x27;media&#x27;</code>.
That aligns well with the new &quot;media as message&quot; model. Below is the minimal
mapping from the current CSV JSON into the unified schema:</p>
<ul>
<li class="">
<p>kind and core fields</p>
<ul>
<li class=""><code>message_kind</code> → <code>messageKind</code></li>
<li class=""><code>text</code> → <code>text</code></li>
<li class=""><code>service</code> (lowercased) → <code>service</code></li>
<li class=""><code>is_from_me</code> → <code>isFromMe</code></li>
<li class=""><code>date</code>, <code>date_read</code>, <code>date_delivered</code>, <code>date_edited</code> → <code>date</code>, <code>dateRead</code>,
<code>dateDelivered</code>, <code>dateEdited</code></li>
<li class=""><code>chat_id</code> → <code>chatId</code></li>
<li class=""><code>group_guid</code> → <code>groupGuid</code></li>
<li class=""><code>subject</code> → <code>subject</code></li>
<li class=""><code>is_unsent</code> → <code>isUnsent</code></li>
<li class=""><code>is_edited</code> → <code>isEdited</code></li>
</ul>
</li>
<li class="">
<p>media (attachments → single media)</p>
<ul>
<li class=""><code>attachments[0]</code> (when <code>message_kind = &#x27;media&#x27;</code>) → <code>media</code>
<ul>
<li class=""><code>attachments[0].copied_path</code> → <code>media.path</code></li>
<li class=""><code>attachments[0].filename</code> → <code>media.filename</code></li>
<li class=""><code>attachments[0].mime_type</code> → <code>media.mimeType</code></li>
<li class=""><code>attachments[0].uti</code> → <code>media.uti</code></li>
<li class=""><code>attachments[0].total_bytes</code> → <code>media.size</code></li>
</ul>
</li>
<li class=""><code>attachment_type</code> → infer <code>media.mediaKind</code> from MIME
(image/audio/video/pdf/unknown)</li>
<li class="">If CSV marks missing files (<code>attachment_missing</code>): set <code>media.path</code> to null
and retain filename; optionally store a <code>mediaMissing: true</code> flag in an
extension field if desired</li>
</ul>
</li>
<li class="">
<p>replies and tapbacks</p>
<ul>
<li class=""><code>replying_to</code> (parsed object) → <code>replyingTo</code> with <code>sender</code>, <code>date</code>, <code>text</code></li>
<li class="">Linking pass sets <code>associated_message_guid</code> → map to:<!-- -->
<ul>
<li class=""><code>replyingTo.targetMessageGuid</code> for reply messages</li>
<li class=""><code>tapback.targetMessageGuid</code> for reaction messages</li>
</ul>
</li>
<li class=""><code>tapback</code> payload (type/action/emoji/target_text) → <code>tapback</code> with
equivalent fields; note <code>target_text</code> becomes <code>targetText</code></li>
</ul>
</li>
<li class="">
<p>fields to keep as meta or drop</p>
<ul>
<li class=""><code>message_type</code> (Incoming/Outgoing/Notification): redundant with <code>isFromMe</code>
and <code>messageKind</code>; keep only if helpful for analytics</li>
<li class=""><code>status</code>, <code>is_read</code>, <code>is_delivered</code>: retain booleans; raw <code>status</code> string
can move to <code>meta</code> if needed</li>
<li class=""><code>num_attachments</code>, <code>timestamp_index</code>: optional debug/ordering helpers; can
be placed under a <code>meta.sequenceIndex</code></li>
<li class=""><code>sender_name</code>: CSV-only label; recommend adding optional
<code>senderName?: string | null</code> if you want to preserve it explicitly (else map
into <code>handle</code> fallback)</li>
</ul>
</li>
</ul>
<p>Net result: No semantic drift. The only structural change is collapsing
<code>attachments[0]</code> into <code>media</code> and camelCasing field names. Linking info moves
from a top-level <code>associated_message_guid</code> to the appropriate nested field
within <code>replyingTo</code> or <code>tapback</code>.</p>
<p>If you’d like, we can include <code>senderName?: string | null</code> and
<code>mediaMissing?: boolean</code> in the schema as optional fields. Otherwise, both can
be handled in the normalize stage as metadata.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="db-exporter-drift--mapping">DB exporter drift &amp; mapping<a href="#db-exporter-drift--mapping" class="hash-link" aria-label="Direct link to DB exporter drift &amp; mapping" title="Direct link to DB exporter drift &amp; mapping" translate="no">​</a></h2>
<p>The DB exporter currently emits one message per DB row with an <code>attachments</code>
array and no <code>message_kind</code>. To align with the CSV output and the unified schema
(media as standalone messages), apply the following:</p>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="current-shape-db">current shape (db)<a href="#current-shape-db" class="hash-link" aria-label="Direct link to current shape (db)" title="Direct link to current shape (db)" translate="no">​</a></h3>
<ul>
<li class="">One message object with:<!-- -->
<ul>
<li class=""><code>text</code> (possibly null)</li>
<li class=""><code>attachments: Array&lt;{ filename, mime_type, uti, total_bytes, copied_path, ... }&gt;</code></li>
<li class=""><code>num_attachments</code></li>
<li class="">tapback fields: <code>associated_message_guid</code>, <code>associated_message_type</code>,
<code>associated_message_emoji</code>, and <code>tapback</code></li>
<li class="">no <code>message_kind</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="desired-shape-aligned">desired shape (aligned)<a href="#desired-shape-aligned" class="hash-link" aria-label="Direct link to desired shape (aligned)" title="Direct link to desired shape (aligned)" translate="no">​</a></h3>
<ul>
<li class="">Split each DB row into multiple message objects:<!-- -->
<ul>
<li class="">Text message if <code>text</code> exists → <code>messageKind = &#x27;text&#x27;</code></li>
<li class="">For each attachment → a separate media message with <code>messageKind = &#x27;media&#x27;</code>
and a single <code>media</code> payload</li>
<li class="">Tapback message when <code>associated_message_type</code> ∈ 2000–3006 →
<code>messageKind = &#x27;tapback&#x27;</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="grouping-and-guids">grouping and guids<a href="#grouping-and-guids" class="hash-link" aria-label="Direct link to grouping and guids" title="Direct link to grouping and guids" translate="no">​</a></h3>
<ul>
<li class="">Use the DB <code>guid</code> as the shared <code>groupGuid</code> for all parts from a single DB row</li>
<li class="">Assign part GUIDs to support precise linking:<!-- -->
<ul>
<li class="">Text part: <code>guid = p:0/&lt;DB guid&gt;</code></li>
<li class="">First media: <code>guid = p:1/&lt;DB guid&gt;</code>; next media: <code>p:2/&lt;DB guid&gt;</code>, etc.</li>
<li class="">This mirrors the DB’s own convention in <code>associated_message_guid</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="field-mappings-db--unified-schema">field mappings (db → unified schema)<a href="#field-mappings-db--unified-schema" class="hash-link" aria-label="Direct link to field mappings (db → unified schema)" title="Direct link to field mappings (db → unified schema)" translate="no">​</a></h3>
<ul>
<li class="">
<p>core and naming</p>
<ul>
<li class="">add <code>messageKind</code> per part</li>
<li class="">camelCase: <code>is_from_me</code> → <code>isFromMe</code>, <code>date_read</code> → <code>dateRead</code>, etc.</li>
<li class=""><code>chat_id</code> → <code>chatId</code>, <code>group_title</code> → <code>groupTitle</code></li>
<li class=""><code>export_timestamp</code> → <code>exportTimestamp</code>, <code>export_version</code> → <code>exportVersion</code></li>
</ul>
</li>
<li class="">
<p>media</p>
<ul>
<li class="">For each <code>attachments[i]</code> → <code>media</code> object on a media message:<!-- -->
<ul>
<li class=""><code>media.path</code> ← <code>attachments[i].copied_path</code></li>
<li class=""><code>media.filename</code> ← <code>attachments[i].filename</code></li>
<li class=""><code>media.mimeType</code> ← <code>attachments[i].mime_type</code></li>
<li class=""><code>media.uti</code> ← <code>attachments[i].uti</code></li>
<li class=""><code>media.size</code> ← <code>attachments[i].total_bytes</code></li>
<li class=""><code>media.mediaKind</code> inferred from <code>media.mimeType</code></li>
<li class=""><code>media.id</code> = stable hash of <code>{path|filename+size}</code> (fallback to attachment
rowid)</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p>replies and tapbacks</p>
<ul>
<li class="">If <code>thread_originator_guid</code> present: set <code>replyingTo.targetMessageGuid</code></li>
<li class="">If <code>tapback</code> present: set <code>tapback</code> fields and <code>tapback.targetMessageGuid</code>
from <code>associated_message_guid</code></li>
<li class="">Normalize stage will point to the correct part GUID</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="algorithm-db-split">algorithm (db split)<a href="#algorithm-db-split" class="hash-link" aria-label="Direct link to algorithm (db split)" title="Direct link to algorithm (db split)" translate="no">​</a></h3>
<ol>
<li class="">Per DB row, produce 0–1 text message, N media messages, 0–1 tapback message</li>
<li class="">Use <code>groupGuid = &lt;DB guid&gt;</code> and part GUIDs as <code>p:&lt;index&gt;/&lt;DB guid&gt;</code></li>
<li class="">Carry <code>date</code>, <code>isFromMe</code>, and other core fields onto all parts</li>
<li class="">Defer linking to normalize stage</li>
</ol>
<p>This change aligns DB output with CSV output and the unified schema, enabling
consistent downstream enrichment and rendering.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="linking--deduplication-strategy">linking &amp; deduplication strategy<a href="#linking--deduplication-strategy" class="hash-link" aria-label="Direct link to linking &amp; deduplication strategy" title="Direct link to linking &amp; deduplication strategy" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="identifiers">identifiers<a href="#identifiers" class="hash-link" aria-label="Direct link to identifiers" title="Direct link to identifiers" translate="no">​</a></h3>
<ul>
<li class="">DB messages already have stable <code>guid</code></li>
<li class="">CSV messages need synthetic canonical IDs<!-- -->
<ul>
<li class="">Recommend <code>guid = csv:&lt;rowid&gt;:&lt;partIndex&gt;</code> to match your current
part-splitting logic</li>
<li class="">Preserve original CSV row index as <code>rowid</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="deduplication">deduplication<a href="#deduplication" class="hash-link" aria-label="Direct link to deduplication" title="Direct link to deduplication" translate="no">​</a></h3>
<ul>
<li class="">Primary key: <code>guid</code> when present</li>
<li class="">For CSV-only or pre-guid data, use a deterministic fingerprint:<!-- -->
<ul>
<li class="">Hash of
<code>{chatSession|chatId, senderId|handle, isoDateSecond, normalizedText, partIndex}</code></li>
<li class="">If attachments exist without text, include <code>{attachment.filename, size}</code> in
the fingerprint</li>
</ul>
</li>
<li class="">When merging CSV + DB data, prefer DB record as authoritative and mark CSV
record as merged</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="reply-linking">reply linking<a href="#reply-linking" class="hash-link" aria-label="Direct link to reply linking" title="Direct link to reply linking" translate="no">​</a></h3>
<ul>
<li class="">Build indices by <code>guid</code> and by timestamp (second resolution)</li>
<li class="">For reply messages with a reference date:<!-- -->
<ul>
<li class="">Exact timestamp bucket → candidates</li>
<li class="">Expand ±5 minutes when necessary</li>
<li class="">Filter by sender if present</li>
<li class="">Prefer same <code>groupGuid</code>/moment when collisions occur</li>
<li class="">Rank by snippet overlap for text replies; for media replies, prefer
candidates with <code>messageKind = &#x27;media&#x27;</code></li>
<li class="">On tie, choose nearest prior message in same moment</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="tapback-linking">tapback linking<a href="#tapback-linking" class="hash-link" aria-label="Direct link to tapback linking" title="Direct link to tapback linking" translate="no">​</a></h3>
<ul>
<li class="">For reaction messages, look back up to 5 minutes</li>
<li class="">Filter out non-target kinds (ignore tapbacks/notifications in candidates)</li>
<li class="">Prefer exact <code>associated_message_guid</code> if known (DB)</li>
<li class="">Rank by text snippet overlap or image/media presence for media reactions</li>
<li class="">Fallback to nearest prior message in same <code>groupGuid</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="reply-threading-parity-csv--db">reply threading parity (CSV ↔ DB)<a href="#reply-threading-parity-csv--db" class="hash-link" aria-label="Direct link to reply threading parity (CSV ↔ DB)" title="Direct link to reply threading parity (CSV ↔ DB)" translate="no">​</a></h3>
<p>Reuse the exact CSV heuristic for both sources to ensure identical behavior:</p>
<ul>
<li class="">
<p>indices</p>
<ul>
<li class="">Build <code>byGuid</code> and <code>byTimestamp</code> (second-resolution buckets)</li>
<li class="">Sort candidates first by exact timestamp match; expand to a ±5 minute window
if needed</li>
</ul>
</li>
<li class="">
<p>candidate filters</p>
<ul>
<li class="">Same sender (when <code>replyingTo.sender</code> is known)</li>
<li class="">Same <code>groupGuid</code> (same “moment”) when available</li>
</ul>
</li>
<li class="">
<p>scoring (as implemented in CSV tool)</p>
<ul>
<li class="">Text replies<!-- -->
<ul>
<li class="">candidate.text startsWith(snippet): +100</li>
<li class="">candidate.text includes(snippet): +50</li>
</ul>
</li>
<li class="">Media-implied replies (no snippet or mentions image/photo):<!-- -->
<ul>
<li class="">candidate.message_kind === &#x27;media&#x27;: +80</li>
<li class="">Prefer lower <code>timestamp_index</code> (earlier part in the moment): +(10 -
timestamp_index)</li>
</ul>
</li>
<li class="">Timestamp proximity<!-- -->
<ul>
<li class="">exact second match: +20</li>
<li class="">otherwise: subtract absolute time delta (seconds)</li>
</ul>
</li>
<li class="">Choose highest score; on tie, fallback to nearest prior in same <code>groupGuid</code></li>
</ul>
</li>
<li class="">
<p>DB alignment</p>
<ul>
<li class="">Primary: use <code>associated_message_guid</code> from DB when present to set
<code>replyingTo.targetMessageGuid</code> (points to <code>p:&lt;index&gt;/&lt;guid&gt;</code> after split)</li>
<li class="">Fallback: apply the same scoring heuristic above when the association isn’t
available or resolvable</li>
<li class="">Ensure DB split emits part GUIDs (<code>p:0/&lt;guid&gt;</code>, <code>p:1/&lt;guid&gt;</code>, …) so
associations resolve to the correct part</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="media-normalization">media normalization<a href="#media-normalization" class="hash-link" aria-label="Direct link to media normalization" title="Direct link to media normalization" translate="no">​</a></h3>
<ul>
<li class="">Ensure <code>media.path</code> is an absolute full path (not relative)</li>
<li class="">Normalize <code>mimeType</code> and compute <code>mediaKind</code> from <code>mimeType</code></li>
<li class="">Compute <code>media.id</code> = stable hash of <code>{path|filename+size}</code></li>
<li class="">Optionally de-duplicate identical media across messages if your data model
ever reuses files</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="performance-resilience-and-resumability">performance, resilience, and resumability<a href="#performance-resilience-and-resumability" class="hash-link" aria-label="Direct link to performance, resilience, and resumability" title="Direct link to performance, resilience, and resumability" translate="no">​</a></h2>
<ul>
<li class="">Enrichment is the slow stage; treat it as a pure augmentation job</li>
<li class="">Rate limiting: reuse your <code>rateLimitedDelay</code> and extend with exponential
backoff on 429/5xx</li>
<li class="">Concurrency: cap to a small thread pool (1–2) to avoid API throttling</li>
<li class="">Checkpointing: keep a single <code>.checkpoint.json</code> with<!-- -->
<ul>
<li class="">lastProcessedIndex</li>
<li class="">stats (counts, images, audio, links, errors)</li>
<li class="">partial <code>enrichedMessages</code> and <code>fullDescriptions</code></li>
</ul>
</li>
<li class="">Idempotency: enrichment results are keyed by <code>media.id</code> and <code>kind</code>; skip if
already present</li>
<li class="">Integrity: write via temp files and atomic rename to avoid corruption</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="file-layout--tooling">file layout &amp; tooling<a href="#file-layout--tooling" class="hash-link" aria-label="Direct link to file layout &amp; tooling" title="Direct link to file layout &amp; tooling" translate="no">​</a></h2>
<p>Proposed minimal layout while keeping your existing <code>.scripts</code> folder:</p>
<div class="language-text codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-text codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token plain">.scripts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pipeline/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingest-csv.mts            # refactor from convert-csv-to-json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingest-db.mts             # refactor from export-imessages-json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    normalize-link.mts        # merge, dedup, link replies/tapbacks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enrich-ai.mts             # AI-only enrichment (Gemini, Firecrawl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    render-markdown.mts       # markdown only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message.ts                # types + zod schemas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pipeline.config.json      # shared config</span><br></span></code></pre></div></div>
<ul>
<li class="">Use <code>.mts</code> for TS ESM scripts run via <code>tsx</code> or <code>ts-node</code></li>
<li class="">Keep your <code>message-analyzer-config.json</code> shape, but separate renderer options
(paths, formatting) from enrichment options (models, rate limits)</li>
<li class="">Add a small <code>src/lib/</code> with shared utilities (date, MIME, hashing)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="packagejson-scripts-pnpm">package.json scripts (pnpm)<a href="#packagejson-scripts-pnpm" class="hash-link" aria-label="Direct link to package.json scripts (pnpm)" title="Direct link to package.json scripts (pnpm)" translate="no">​</a></h3>
<div class="language-jsonc codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-jsonc codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;scripts&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pipeline:ingest:csv&quot;: &quot;tsx ./.scripts/pipeline/ingest-csv.mts -c ./.scripts/config/pipeline.config.json&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pipeline:ingest:db&quot;: &quot;tsx ./.scripts/pipeline/ingest-db.mts -c ./.scripts/config/pipeline.config.json&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pipeline:normalize&quot;: &quot;tsx ./.scripts/pipeline/normalize-link.mts -c ./.scripts/config/pipeline.config.json&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pipeline:enrich&quot;: &quot;tsx ./.scripts/pipeline/enrich-ai.mts -c ./.scripts/config/pipeline.config.json&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pipeline:render&quot;: &quot;tsx ./.scripts/pipeline/render-markdown.mts -c ./.scripts/config/pipeline.config.json&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="security--privacy">security &amp; privacy<a href="#security--privacy" class="hash-link" aria-label="Direct link to security &amp; privacy" title="Direct link to security &amp; privacy" translate="no">​</a></h2>
<ul>
<li class="">API keys only via env and not persisted in checkpoint files</li>
<li class="">Provide a <code>--redact</code> option to mask PII before writing markdown</li>
<li class="">Local-only mode: allow disabling external calls (skip enrichment, render raw)</li>
<li class="">Maintain a <code>provenance</code> block on enrichment payloads with model, version, and
timestamp</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="dates--timezones">dates &amp; timezones<a href="#dates--timezones" class="hash-link" aria-label="Direct link to dates &amp; timezones" title="Direct link to dates &amp; timezones" translate="no">​</a></h2>
<p>Consistent timestamps are essential for deterministic linking and ordering.</p>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="csv-source">CSV source<a href="#csv-source" class="hash-link" aria-label="Direct link to CSV source" title="Direct link to CSV source" translate="no">​</a></h3>
<ul>
<li class="">iMazing CSV timestamps are UTC; the converter appends <code>Z</code> and uses
<code>new Date(&lt;YYYY-MM-DDTHH:mm:ss&gt;Z).toISOString()</code></li>
<li class="">This yields ISO 8601 strings with <code>Z</code> (UTC) and is safe for cross-platform
parsing</li>
<li class="">Keep as-is. Treat CSV as authoritative UTC for its timestamps</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="db-source">DB source<a href="#db-source" class="hash-link" aria-label="Direct link to DB source" title="Direct link to DB source" translate="no">​</a></h3>
<ul>
<li class="">Apple stores nanoseconds since 2001-01-01 00:00:00 UTC (Apple epoch)</li>
<li class="">Current code converts via: <code>unix = apple_ns / 1e9 + APPLE_EPOCH_SECONDS</code> then
<code>.toISOString()</code></li>
<li class="">This produces ISO 8601 UTC strings (with <code>Z</code>)—which matches the CSV</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="invariants-and-validation">invariants and validation<a href="#invariants-and-validation" class="hash-link" aria-label="Direct link to invariants and validation" title="Direct link to invariants and validation" translate="no">​</a></h3>
<ul>
<li class="">All date-like fields in the unified schema must be ISO 8601 with <code>Z</code> or offset<!-- -->
<ul>
<li class="">Enforced in Zod using <code>z.string().datetime()</code></li>
</ul>
</li>
<li class="">Fields: <code>date</code>, <code>dateRead</code>, <code>dateDelivered</code>, <code>dateEdited</code>, <code>exportTimestamp</code>,
and any nested times in enrichment must be valid ISO</li>
<li class="">When ingesting CSV, ensure <code>convertToISO8601</code> normalizes reliably and logs any
parse errors</li>
<li class="">When ingesting DB, normalize through the Apple epoch converter; avoid
locale-dependent formatting</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="ordering-and-grouping">ordering and grouping<a href="#ordering-and-grouping" class="hash-link" aria-label="Direct link to ordering and grouping" title="Direct link to ordering and grouping" translate="no">​</a></h3>
<ul>
<li class="">Sort by <code>date</code> (ms precision) and then stable part index when splitting a
single moment</li>
<li class="">Linking by timestamp should round to seconds for bucket lookup but maintain ms
precision in storage</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="display-vs-storage">display vs storage<a href="#display-vs-storage" class="hash-link" aria-label="Direct link to display vs storage" title="Direct link to display vs storage" translate="no">​</a></h3>
<ul>
<li class="">Storage: always UTC ISO 8601</li>
<li class="">Display in markdown: localize at render time only (e.g., using
<code>toLocaleTimeString</code>)</li>
</ul>
<p>Outcome: CSV and DB agree on UTC ISO timestamps with <code>Z</code>; linking and enrichment
operate on a single, consistent notion of time.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="media-path-resolution--provenance">media path resolution &amp; provenance<a href="#media-path-resolution--provenance" class="hash-link" aria-label="Direct link to media path resolution &amp; provenance" title="Direct link to media path resolution &amp; provenance" translate="no">​</a></h2>
<p>Final JSON must carry absolute paths to media files because files can originate
from multiple sources (macOS Messages attachments directory vs iMazing backup
directory). Store both a display name and the absolute path:</p>
<ul>
<li class=""><code>media.filename</code>: the display/original filename</li>
<li class=""><code>media.path</code>: absolute full path to the file on disk</li>
<li class="">Optional: <code>media.provenance?: &#x27;db&#x27; | &#x27;imazing&#x27;</code> to capture source;
<code>version?: string</code> if desired</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="csv-resolver-imazing-backups">CSV resolver (iMazing backups)<a href="#csv-resolver-imazing-backups" class="hash-link" aria-label="Direct link to CSV resolver (iMazing backups)" title="Direct link to CSV resolver (iMazing backups)" translate="no">​</a></h3>
<ul>
<li class="">Strategy implemented in CSV converter:<!-- -->
<ul>
<li class="">Skip <code>.pluginPayloadAttachment</code></li>
<li class="">For bare filenames, build an exact timestamp prefix using the message date
in UTC: <code>YYYY-MM-DD HH MM SS</code></li>
<li class="">Match files in the configured attachments directory with pattern:<!-- -->
<ul>
<li class=""><code>&quot;&lt;timestamp&gt; - &lt;Sender Name&gt; - &lt;originalfilename.ext&gt;&quot;</code></li>
<li class="">Choose first exact match; if none, mark as missing and still emit a media
message (filename retained, path null)</li>
</ul>
</li>
<li class="">For DB-style absolute paths in CSV, expand <code>~</code> and validate existence</li>
</ul>
</li>
<li class="">Action: Document this filename pattern and keep it stable; log misses
explicitly</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="db-resolver-messages-attachments">DB resolver (Messages attachments)<a href="#db-resolver-messages-attachments" class="hash-link" aria-label="Direct link to DB resolver (Messages attachments)" title="Direct link to DB resolver (Messages attachments)" translate="no">​</a></h3>
<ul>
<li class="">Strategy implemented in DB exporter:<!-- -->
<ul>
<li class="">Preferred: search iMazing-style date-prefixed files when <code>transfer_name</code> and
message date are known</li>
<li class="">Fallbacks:<!-- -->
<ul>
<li class="">Use <code>filename</code> if absolute</li>
<li class="">Expand <code>~</code></li>
<li class="">Join the last 4 components under the configured <code>attachmentBasePath</code></li>
<li class="">Use <code>transfer_name</code> under <code>attachmentBasePath</code></li>
</ul>
</li>
</ul>
</li>
<li class="">In practice, DB attachment resolution is usually simpler because the database
paths or transfer names map directly to the Messages attachments hierarchy</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="policy--validation">policy &amp; validation<a href="#policy--validation" class="hash-link" aria-label="Direct link to policy &amp; validation" title="Direct link to policy &amp; validation" translate="no">​</a></h3>
<ul>
<li class="">Always write <code>media.path</code> as an absolute path; retain <code>media.filename</code> for
human readability</li>
<li class="">Use <code>media.id</code> derived from <code>{path|filename+size}</code> to remain stable across
sources</li>
<li class="">Optional: set <code>media.provenance</code> = &#x27;imazing&#x27; for CSV-derived files, &#x27;db&#x27; for
DB-derived files</li>
<li class="">In validation: assert <code>media.path</code> is absolute when present; allow null only
for missing files captured intentionally by the CSV resolver</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="testing--ci-vitest">testing &amp; CI (Vitest)<a href="#testing--ci-vitest" class="hash-link" aria-label="Direct link to testing &amp; CI (Vitest)" title="Direct link to testing &amp; CI (Vitest)" translate="no">​</a></h2>
<ul>
<li class="">Use Vitest with <code>threads</code> pool capped at 8, <code>allowOnly: false</code></li>
<li class="">Place tests under <code>__tests__/</code> with <code>.test.ts</code> suffix</li>
<li class="">Use <code>environment: &#x27;node&#x27;</code> for CLI units; <code>jsdom</code> for any DOM-specific
rendering helpers</li>
<li class="">Mock external services with <code>vi.mock()</code>; reset via <code>vi.resetAllMocks()</code> in
<code>beforeEach</code></li>
<li class="">Coverage: V8 coverage via <code>@vitest/coverage</code>, thresholds ≥ 70%</li>
<li class="">CI reporters: junit to <code>./test-results/junit.xml</code> and coverage to
<code>./test-results/coverage/</code></li>
</ul>
<p>Example: enrichment unit tests</p>
<div class="language-ts codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-ts codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> describe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> it</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beforeEach</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vi </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;vitest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> enrichAttachment </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;#lib/enrich&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;@google/generative-ai&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* stub genAI */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;@mendable/firecrawl-js&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* stub Firecrawl */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;enrichAttachment&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">beforeEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resetAllMocks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;adds a vision summary for images&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> att </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;a1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/tmp/photo.jpg&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filename</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;photo.jpg&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mimeType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;image/jpeg&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> out </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enrichAttachment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">att</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> enableVisionAnalysis</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enrichment</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enrichment</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">visionSummary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBeDefined</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="migration-plan">migration plan<a href="#migration-plan" class="hash-link" aria-label="Direct link to migration plan" title="Direct link to migration plan" translate="no">​</a></h2>
<ol>
<li class="">Introduce schema</li>
</ol>
<ul>
<li class="">Add <code>src/schema/message.ts</code> with TypeScript + Zod</li>
<li class="">Validate current outputs from both ingesters; adapt fields to match the schema</li>
</ul>
<ol start="2">
<li class="">Split analysis and rendering</li>
</ol>
<ul>
<li class="">Extract markdown generation from <code>.scripts/analyze-messages-json.mjs</code> into
<code>render-markdown.mts</code></li>
<li class="">Keep enrichment-only logic in <code>enrich-ai.mts</code></li>
</ul>
<ol start="3">
<li class="">Centralize linking &amp; dedup</li>
</ol>
<ul>
<li class="">Create <code>normalize-link.mts</code> that consumes the CSV and DB outputs and emits a
single <code>messages.normalized.json</code></li>
</ul>
<ol start="4">
<li class="">Idempotent enrichment</li>
</ol>
<ul>
<li class="">Implement media-level enrichment keyed by <code>media.id</code></li>
<li class="">Add checkpoint + resume using a single checkpoint file</li>
</ul>
<ol start="5">
<li class="">Render deterministic markdown</li>
</ol>
<ul>
<li class="">Consume <code>messages.enriched.json</code> only</li>
<li class="">No network calls, no enrichment logic</li>
</ul>
<ol start="6">
<li class="">Backfill &amp; verify</li>
</ol>
<ul>
<li class="">Run the whole pipeline on a known slice</li>
<li class="">Compare markdown diffs between old and new to ensure parity</li>
<li class="">Reconcile any intentional format changes</li>
</ul>
<ol start="7">
<li class="">Validate dates end-to-end</li>
</ol>
<ul>
<li class="">Add a small validator script that loads CSV and DB artifacts and asserts:<!-- -->
<ul>
<li class="">All message dates are ISO 8601 with <code>Z</code></li>
<li class="">DB Apple-epoch conversion produces stable UTC timestamps matching CSV
alignment</li>
<li class="">Sorting by <code>date</code> and part-index yields deterministic order</li>
</ul>
</li>
</ul>
<ol start="8">
<li class="">Cutover</li>
</ol>
<ul>
<li class="">Replace old scripts with new pipeline commands in <code>package.json</code></li>
<li class="">Archive legacy scripts and document the migration</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="risks--mitigations">risks &amp; mitigations<a href="#risks--mitigations" class="hash-link" aria-label="Direct link to risks &amp; mitigations" title="Direct link to risks &amp; mitigations" translate="no">​</a></h2>
<ul>
<li class="">API rate limits → strict concurrency caps, retries, and exponential backoff</li>
<li class="">Data drift between CSV and DB → deterministic dedup rules and prefer DB as
truth when GUID exists</li>
<li class="">Breaking schema changes → version the schema and exportVersion; provide
migration notes</li>
<li class="">Large datasets → streaming writes and per-day chunked rendering; consider
splitting enriched JSON per month if necessary</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="timeline-suggested">timeline (suggested)<a href="#timeline-suggested" class="hash-link" aria-label="Direct link to timeline (suggested)" title="Direct link to timeline (suggested)" translate="no">​</a></h2>
<ul>
<li class="">Day 1–2: Land schema + validation; adapt CSV/DB ingesters to schema</li>
<li class="">Day 3: Build normalize-link stage and stabilize linking/dedup</li>
<li class="">Day 4–5: Extract enrichment + checkpointing; separate renderer; parity test on
sample</li>
<li class="">Day 6: Wire Vitest + coverage + CI reporters; add minimal tests</li>
<li class="">Day 7: Backfill historical data; finalize docs and cutover</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="appendix-a--example-json-enriched">appendix A — example JSON (enriched)<a href="#appendix-a--example-json-enriched" class="hash-link" aria-label="Direct link to appendix A — example JSON (enriched)" title="Direct link to appendix A — example JSON (enriched)" translate="no">​</a></h2>
<div class="language-json codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-json codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;createdAt&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2025-10-17T03:30:00.000Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;messages&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;date&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2023-10-23T06:52:57.000Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;guid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DB:XYZ-123&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;isFromMe&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;media&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;enrichment&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;createdAt&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2025-10-17T03:31:00.000Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;kind&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;image&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;model&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gemini-1.5-pro&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;gemini&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;shortDescription&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Outdoor brunch photo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2025-10-17&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;visionSummary&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Two people brunching outdoors...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;filename&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IMG_2199.jpeg&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;media:sha1:...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;mediaKind&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;image&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;mimeType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;image/jpeg&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/abs/path/IMG_2199.jpeg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;messageKind&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;media&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;text&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;schemaVersion&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2.0.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;source&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;merged&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="appendix-b--cli-surface-proposed">appendix B — CLI surface (proposed)<a href="#appendix-b--cli-surface-proposed" class="hash-link" aria-label="Direct link to appendix B — CLI surface (proposed)" title="Direct link to appendix B — CLI surface (proposed)" translate="no">​</a></h2>
<ul>
<li class=""><code>pnpm pipeline:ingest:csv -i &lt;csv&gt; -o raw.csv.json</code></li>
<li class=""><code>pnpm pipeline:ingest:db -c &lt;config&gt; -o raw.db.json</code></li>
<li class=""><code>pnpm pipeline:normalize -i raw.csv.json -i raw.db.json -o messages.normalized.json</code></li>
<li class=""><code>pnpm pipeline:enrich -i messages.normalized.json -o messages.enriched.json --resume</code></li>
<li class=""><code>pnpm pipeline:render -i messages.enriched.json -o ./02_Areas/.../</code></li>
</ul>
<p>Each step validates its inputs against Zod and writes versioned outputs.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="completion-summary">completion summary<a href="#completion-summary" class="hash-link" aria-label="Direct link to completion summary" title="Direct link to completion summary" translate="no">​</a></h2>
<ul>
<li class="">Proposed a clean four-stage pipeline that separates concerns</li>
<li class="">Defined a unified schema with TypeScript types and Zod validators
(<code>superRefine</code> for invariants)</li>
<li class="">Specified deterministic linking and deduplication rules</li>
<li class="">Outlined resiliency measures (rate limits, checkpoints, idempotency)</li>
<li class="">Provided test/CI guidance using Vitest</li>
<li class="">Detailed a migration plan and timeline</li>
</ul>
<p>Open to iterate on the schema and file layout once you decide where you want the
new <code>src/</code> or <code>.scripts/pipeline</code> to live.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="appendix-c--csv-converter-deep-dive-domains-gaps-improvements">appendix C — CSV converter deep-dive: domains, gaps, improvements<a href="#appendix-c--csv-converter-deep-dive-domains-gaps-improvements" class="hash-link" aria-label="Direct link to appendix C — CSV converter deep-dive: domains, gaps, improvements" title="Direct link to appendix C — CSV converter deep-dive: domains, gaps, improvements" translate="no">​</a></h2>
<p>A focused audit of <code>.scripts/convert-csv-to-json.mjs</code> to ensure coverage across
message domains and alignment with the unified schema.</p>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="domains-covered-well-today">domains covered well today<a href="#domains-covered-well-today" class="hash-link" aria-label="Direct link to domains covered well today" title="Direct link to domains covered well today" translate="no">​</a></h3>
<ul>
<li class="">Message splitting per CSV row into multiple messages by “moment”<!-- -->
<ul>
<li class="">text message for body text</li>
<li class="">media message when an attachment is present</li>
<li class="">separate tapback and notification messages</li>
</ul>
</li>
<li class="">UTC handling for dates with <code>.toISOString()</code> and <code>Z</code> suffix</li>
<li class="">Reply parsing from “➜ Replying to … « … »” into structured object</li>
<li class="">Tapback detection with smart-quote patterns and emoji reactions</li>
<li class="">iMazing attachment resolution via timestamped filename pattern</li>
<li class="">Deterministic sort by date then <code>timestamp_index</code></li>
<li class="">Linking pass for replies and tapbacks using timestamp buckets</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="notable-gaps-or-risks">notable gaps or risks<a href="#notable-gaps-or-risks" class="hash-link" aria-label="Direct link to notable gaps or risks" title="Direct link to notable gaps or risks" translate="no">​</a></h3>
<ul>
<li class="">
<p>chat_id is hard-coded to <code>62</code></p>
<ul>
<li class="">risk: implies a fixed chat that may not correspond to reality</li>
<li class="">recommendation: set <code>chatId: null</code> in CSV ingest; let normalize-link infer
or map if desired, or keep <code>chat_session</code> as human label only</li>
</ul>
</li>
<li class="">
<p>reply linking window collects only the first non-empty second</p>
<ul>
<li class="">current logic: in <code>resolveReplyTarget</code>, the ±5 minute search breaks on the
first second that has candidates and does not aggregate all candidates
across the window</li>
<li class="">risk: could miss a better-scoring candidate that occurs a few seconds later</li>
<li class="">recommendation: mirror the tapback approach and aggregate all candidates
across the whole window before scoring</li>
</ul>
</li>
<li class="">
<p>tapback removal patterns are incomplete</p>
<ul>
<li class="">supported removal: only “Removed a heart from …”</li>
<li class="">missing: removal for liked, disliked, laughed, emphasized, questioned</li>
<li class="">recommendation: add analogous “Removed a like from …”, “Removed a laugh from
…”, etc., and add media variants like “Removed a like from an image” when
applicable</li>
</ul>
</li>
<li class="">
<p>limited media phrases</p>
<ul>
<li class="">supported: “Loved an image”, “Liked an image”, “Emphasized an image”,
“Laughed at an image”</li>
<li class="">possibly missing: “Loved a photo”, “Liked a video”, “Laughed at a video”,
“Emphasized a photo”</li>
<li class="">recommendation: extend pattern synonyms to cover photo/image/video
variations</li>
</ul>
</li>
<li class="">
<p>associated<em>message</em>* fields</p>
<ul>
<li class="">CSV sets <code>associated_message_guid</code> only during linking pass on the message
object</li>
<li class="">schema alignment: we will move these into <code>replyingTo.targetMessageGuid</code> and
<code>tapback.targetMessageGuid</code> during normalize-link</li>
</ul>
</li>
<li class="">
<p>media provenance &amp; absolute paths</p>
<ul>
<li class="">converter returns <code>attachments[0].copied_path</code>; we will map to <code>media.path</code></li>
<li class="">recommendation: ensure path is absolute and set
<code>media.provenance = &#x27;imazing&#x27;</code> in normalize</li>
</ul>
</li>
<li class="">
<p>item_type semantics and status string</p>
<ul>
<li class="">CSV sets <code>item_type: isUnsent ? 1 : 0</code> and leaves <code>status</code> as a string;
booleans for delivered/read are inferred</li>
<li class="">recommendation: treat <code>itemType</code> as optional metadata; keep <code>isRead</code> and
<code>isDelivered</code> as canonical booleans; place raw <code>status</code> in meta if needed</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="parity-requirements-for-db-path">parity requirements for DB path<a href="#parity-requirements-for-db-path" class="hash-link" aria-label="Direct link to parity requirements for DB path" title="Direct link to parity requirements for DB path" translate="no">​</a></h3>
<ul>
<li class="">Use the same reply heuristic and scoring rules as CSV (now documented)</li>
<li class="">Ensure DB split emits <code>p:&lt;index&gt;/&lt;guid&gt;</code> part GUIDs so tapbacks and replies
can resolve to the precise part</li>
<li class="">Prefer DB’s <code>associated_message_guid</code> for linking; fallback to heuristic when
absent</li>
<li class="">Use absolute media paths and set <code>media.provenance = &#x27;db&#x27;</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="low-risk-enhancements">low-risk enhancements<a href="#low-risk-enhancements" class="hash-link" aria-label="Direct link to low-risk enhancements" title="Direct link to low-risk enhancements" translate="no">​</a></h3>
<ul>
<li class="">Add optional <code>senderName?: string | null</code> to schema if you want to preserve
the CSV sender label</li>
<li class="">Add a <code>mediaMissing?: boolean</code> marker when the iMazing resolver can’t find a
file</li>
<li class="">Improve emoji reaction parsing to handle alternate quote styles beyond smart
quotes when encountered</li>
</ul>
<p>These items are either addressed in the normalize-link stage or documented for
targeted improvements to the CSV converter while preserving its proven behavior.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_fz2_" id="implementation-report-october-2025">Implementation Report (October 2025)<a href="#implementation-report-october-2025" class="hash-link" aria-label="Direct link to Implementation Report (October 2025)" title="Direct link to Implementation Report (October 2025)" translate="no">​</a></h2>
<blockquote>
<p><strong>Status</strong>: ✅ Pipeline fully implemented and operational<br>
<strong>Completion</strong>: 28/30 tasks (93% complete)<br>
<strong>Test Coverage</strong>: 764 tests passing, 81.41% branch coverage<br>
<strong>Last Updated</strong>: 2025-10-19</p>
</blockquote>
<p>This section documents the actual implementation against the original refactor
plan, capturing deltas, lessons learned, and architectural decisions made during
development.</p>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="implementation-overview">Implementation Overview<a href="#implementation-overview" class="hash-link" aria-label="Direct link to Implementation Overview" title="Direct link to Implementation Overview" translate="no">​</a></h3>
<p>The four-stage pipeline architecture was successfully implemented with all core
functionality operational:</p>
<div class="language-text codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-text codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────┐     ┌──────────────┐     ┌────────────┐     ┌─────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Ingest    │────▶│  Normalize   │────▶│  Enrich    │────▶│   Render    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CSV + DB   │     │   &amp; Link     │     │  AI APIs   │     │  Markdown   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────┘     └──────────────┘     └────────────┘     └─────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2 modules           6 modules          8 modules          4 modules</span><br></span></code></pre></div></div>
<p><strong>Epic Completion Status:</strong></p>
<ul>
<li class="">✅ E1 (Schema): 3/3 tasks - 100%</li>
<li class="">✅ E2 (Normalize-Link): 8/8 tasks - 100%</li>
<li class="">✅ E3 (Enrich-AI): 8/8 tasks - 100%</li>
<li class="">✅ E4 (Render-Markdown): 4/4 tasks - 100%</li>
<li class="">✅ E5 (CI-Testing-Tooling): 4/4 tasks - 100%</li>
<li class="">⏸️ E6 (Docs-Migration): 0/3 tasks - Documentation in progress</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="architecture-deltas-from-original-plan">Architecture Deltas from Original Plan<a href="#architecture-deltas-from-original-plan" class="hash-link" aria-label="Direct link to Architecture Deltas from Original Plan" title="Direct link to Architecture Deltas from Original Plan" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="-implemented-as-planned">✅ Implemented as Planned<a href="#-implemented-as-planned" class="hash-link" aria-label="Direct link to ✅ Implemented as Planned" title="Direct link to ✅ Implemented as Planned" translate="no">​</a></h4>
<ol>
<li class="">
<p><strong>Four-Stage Pipeline</strong></p>
<ul>
<li class="">Clean separation of concerns achieved</li>
<li class="">Each stage has well-defined inputs and outputs</li>
<li class="">No circular dependencies between stages</li>
</ul>
</li>
<li class="">
<p><strong>Unified Schema with Zod</strong></p>
<ul>
<li class="">Single source of truth in <code>src/schema/message.ts</code></li>
<li class="">Discriminated union on <code>messageKind</code></li>
<li class="">Comprehensive validation with <code>superRefine</code> for cross-field invariants</li>
<li class="">Full TypeScript type safety</li>
</ul>
</li>
<li class="">
<p><strong>Idempotent Enrichment</strong></p>
<ul>
<li class="">Checkpointing every N items (configurable, default 100)</li>
<li class="">Resume within ≤1 item of last checkpoint</li>
<li class="">Config hash verification prevents inconsistent resumes</li>
<li class="">Enrichment arrays append-only (no overwrites)</li>
</ul>
</li>
<li class="">
<p><strong>Deterministic Rendering</strong></p>
<ul>
<li class="">Zero network calls during markdown generation</li>
<li class="">Stable GUID-based sorting for same-timestamp messages</li>
<li class="">SHA-256 hashing verifies identical output across runs</li>
<li class="">Performance: 1000 messages render in <code>&lt;70ms</code></li>
</ul>
</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="-implementation-adjustments">🔄 Implementation Adjustments<a href="#-implementation-adjustments" class="hash-link" aria-label="Direct link to 🔄 Implementation Adjustments" title="Direct link to 🔄 Implementation Adjustments" translate="no">​</a></h4>
<ol>
<li class="">
<p><strong>Module Organization</strong></p>
<ul>
<li class=""><strong>Plan</strong>: Four tools (<code>ingest-csv</code>, <code>ingest-db</code>, <code>normalize-link</code>,
<code>enrich-ai</code>, <code>render-markdown</code>)</li>
<li class=""><strong>Reality</strong>: Modular functions in <code>src/</code> directories, composed into unified
pipeline</li>
<li class=""><strong>Rationale</strong>: Better for testing, code reuse, and TypeScript project
structure</li>
</ul>
</li>
<li class="">
<p><strong>Normalize Directory Split</strong></p>
<ul>
<li class=""><strong>Plan</strong>: Single <code>normalize-link</code> module</li>
<li class=""><strong>Reality</strong>: Split into <code>src/ingest/</code> and <code>src/normalize/</code>
<ul>
<li class=""><code>ingest/</code>: CSV parsing, DB splitting, linking, deduplication</li>
<li class=""><code>normalize/</code>: Date conversion, path validation, Zod validation</li>
</ul>
</li>
<li class=""><strong>Rationale</strong>: Clearer responsibilities, easier to test independently</li>
</ul>
</li>
<li class="">
<p><strong>Enrichment Structure</strong></p>
<ul>
<li class=""><strong>Plan</strong>: Single <code>enrich-ai</code> tool with all enrichment types</li>
<li class=""><strong>Reality</strong>: Modular enrichment functions with orchestration layer<!-- -->
<ul>
<li class=""><code>image-analysis.ts</code> - HEIC/TIFF → JPG, Gemini Vision</li>
<li class=""><code>audio-transcription.ts</code> - Gemini Audio API</li>
<li class=""><code>pdf-video-handling.ts</code> - PDF summarization, video metadata</li>
<li class=""><code>link-enrichment.ts</code> - Firecrawl + fallbacks (YouTube, Spotify, social)</li>
<li class=""><code>idempotency.ts</code> - Skip logic, deduplication by kind</li>
<li class=""><code>checkpoint.ts</code> - State persistence, resume logic</li>
<li class=""><code>rate-limiting.ts</code> - Delays, exponential backoff, circuit breaker</li>
</ul>
</li>
<li class=""><strong>Rationale</strong>: Each enrichment type is independently testable, easier to
extend</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="-additional-features-beyond-original-spec">➕ Additional Features Beyond Original Spec<a href="#-additional-features-beyond-original-spec" class="hash-link" aria-label="Direct link to ➕ Additional Features Beyond Original Spec" title="Direct link to ➕ Additional Features Beyond Original Spec" translate="no">​</a></h4>
<ol>
<li class="">
<p><strong>Test Helper Utilities</strong> (CI--T04)</p>
<ul>
<li class="">Mock provider factories for all AI services</li>
<li class="">Fixture loaders with type-safe message factories</li>
<li class="">Schema assertion helpers with clear error messages</li>
<li class="">Fluent MessageBuilder API for readable test data</li>
<li class=""><strong>Files</strong>: <code>tests/helpers/</code> directory (5 modules, 33 tests, comprehensive
README)</li>
</ul>
</li>
<li class="">
<p><strong>HEIC/TIFF Preview Caching</strong> (ENRICH--T01)</p>
<ul>
<li class="">Convert to JPG once, cache by filename</li>
<li class="">Quality ≥90% preserved</li>
<li class="">Deterministic naming: <code>preview-{originalFilename}.jpg</code></li>
<li class=""><strong>Rationale</strong>: Gemini Vision API requires JPG, caching prevents redundant
conversions</li>
</ul>
</li>
<li class="">
<p><strong>Comprehensive Link Enrichment</strong> (ENRICH--T04)</p>
<ul>
<li class="">Primary: Firecrawl for generic links</li>
<li class="">Fallbacks: YouTube, Spotify, Twitter/X, Instagram</li>
<li class="">Provider factory pattern for easy mocking/extension</li>
<li class="">Graceful degradation (never crashes on link failure)</li>
</ul>
</li>
<li class="">
<p><strong>Enhanced Tapback Rendering</strong> (RENDER--T02)</p>
<ul>
<li class="">Emoji mapping: liked→❤️, loved→😍, laughed→😂, emphasized→‼️,
questioned→❓, disliked→👎</li>
<li class="">Multi-level nesting support (50+ levels tested)</li>
<li class="">Circular reference prevention</li>
<li class="">2-space indentation per nesting level</li>
</ul>
</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="file-structure-as-implemented">File Structure (As Implemented)<a href="#file-structure-as-implemented" class="hash-link" aria-label="Direct link to File Structure (As Implemented)" title="Direct link to File Structure (As Implemented)" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-text codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token plain">imessage-timeline/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── schema/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── message.ts          # Unified Message schema with Zod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ingest/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingest-csv.ts       # iMazing CSV → Message[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingest-db.ts        # Messages.app DB → Message[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── link-replies-and-tapbacks.ts  # Linking logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── dedup-merge.ts      # Cross-source deduplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── normalize/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── date-converters.ts  # CSV UTC + Apple epoch → ISO 8601</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── path-validator.ts   # Absolute path enforcement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── validate-normalized.ts  # Zod validation layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── enrich/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── image-analysis.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── audio-transcription.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── pdf-video-handling.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── link-enrichment.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── idempotency.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── checkpoint.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── rate-limiting.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── index.ts            # Enrichment orchestrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── render/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── grouping.ts         # Date/time-of-day grouping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── reply-rendering.ts  # Nested replies + tapbacks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── embeds-blockquotes.ts  # Images, transcriptions, links</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── index.ts            # Render pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── cli.ts                  # Command-line interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── index.ts                # Main entry point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── tests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── helpers/                # Test utilities (CI--T04)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── mock-providers.ts   # AI service mocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── fixture-loaders.ts  # Test data factories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── schema-assertions.ts  # Validation helpers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── test-data-builders.ts  # Fluent builders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── README.md           # Comprehensive guide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── vitest/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── vitest-setup.ts     # Global test setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── vitest.config.ts            # Test configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── tsconfig.json               # TypeScript configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── package.json                # Dependencies + scripts</span><br></span></code></pre></div></div>
<p><strong>Total Implementation:</strong></p>
<ul>
<li class="">21 source modules</li>
<li class="">764 tests across 23 test files</li>
<li class="">81.41% branch coverage (exceeds 70% requirement)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="lessons-learned--implementation-gotchas">Lessons Learned &amp; Implementation Gotchas<a href="#lessons-learned--implementation-gotchas" class="hash-link" aria-label="Direct link to Lessons Learned &amp; Implementation Gotchas" title="Direct link to Lessons Learned &amp; Implementation Gotchas" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="1-zod-superrefine-performance-schema--t01">1. <strong>Zod superRefine Performance</strong> (SCHEMA--T01)<a href="#1-zod-superrefine-performance-schema--t01" class="hash-link" aria-label="Direct link to 1-zod-superrefine-performance-schema--t01" title="Direct link to 1-zod-superrefine-performance-schema--t01" translate="no">​</a></h4>
<p><strong>Issue</strong>: Initial implementation used separate <code>.refine()</code> calls, causing
redundant validations.</p>
<p><strong>Solution</strong>: Single <code>superRefine</code> with early returns for efficiency.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ❌ Before: Multiple refine calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MessageSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">refine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">media </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">refine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tapback </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ✅ After: Single superRefine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MessageSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">superRefine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">media</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;custom&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;media required&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messageKind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tapback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addIssue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;custom&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tapback required&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: Use <code>superRefine</code> for cross-field validation, not multiple
<code>refine()</code> calls.</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="2-apple-epoch-edge-cases-normalize--t02-normalize--t06">2. <strong>Apple Epoch Edge Cases</strong> (NORMALIZE--T02, NORMALIZE--T06)<a href="#2-apple-epoch-edge-cases-normalize--t02-normalize--t06" class="hash-link" aria-label="Direct link to 2-apple-epoch-edge-cases-normalize--t02-normalize--t06" title="Direct link to 2-apple-epoch-edge-cases-normalize--t02-normalize--t06" translate="no">​</a></h4>
<p><strong>Issue</strong>: Apple epoch starts 2001-01-01, but initial validation assumed max ~1
billion seconds.</p>
<p><strong>Discovery</strong>: Valid dates extend to year 2159 (up to ~5 billion seconds).</p>
<p><strong>Solution</strong>: Expanded validation range and added comprehensive DST/leap second
tests.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ❌ Before: Too restrictive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seconds </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1_000_000_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Invalid epoch&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ✅ After: Realistic range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">APPLE_EPOCH_ZERO</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2001-01-01T00:00:00.000Z&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> date </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">APPLE_EPOCH_ZERO</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> seconds </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: Test edge cases thoroughly. Apple&#x27;s epoch format has surprising
range.</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="3-es-module-mocking-in-vitest-ci--t01-ci--t02">3. <strong>ES Module Mocking in Vitest</strong> (CI--T01, CI--T02)<a href="#3-es-module-mocking-in-vitest-ci--t01-ci--t02" class="hash-link" aria-label="Direct link to 3-es-module-mocking-in-vitest-ci--t01-ci--t02" title="Direct link to 3-es-module-mocking-in-vitest-ci--t01-ci--t02" translate="no">​</a></h4>
<p><strong>Issue</strong>: Simple <code>vi.mock()</code> patterns failed with &quot;No default export&quot; errors.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ❌ Fails with ES modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;fs/promises&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stat</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Solution</strong>: Use <code>importOriginal</code> pattern for proper ES module mocking.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ✅ Works with ES modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;fs/promises&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">importOriginal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> actual </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">importOriginal</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">typeof</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">import</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">(</span><span class="token generic-function generic class-name string" style="color:#e3116c">&#x27;fs/promises&#x27;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">)</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">actual</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mockResolvedValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stat</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> vi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mockResolvedValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: ES module mocks need <code>importOriginal</code> to preserve default exports.</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="4-coverage-instrumentation-overhead-render--t04">4. <strong>Coverage Instrumentation Overhead</strong> (RENDER--T04)<a href="#4-coverage-instrumentation-overhead-render--t04" class="hash-link" aria-label="Direct link to 4-coverage-instrumentation-overhead-render--t04" title="Direct link to 4-coverage-instrumentation-overhead-render--t04" translate="no">​</a></h4>
<p><strong>Issue</strong>: Performance test &quot;scales linearly&quot; passed normally but failed in
coverage mode.</p>
<p><strong>Root Cause</strong>: V8 coverage adds ~10-30% overhead per instrumented line,
breaking 2× tolerance.</p>
<p><strong>Solution</strong>: Detect coverage mode and adjust tolerance accordingly.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isCoverageMode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">global </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__coverage__ </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;undefined&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tolerance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> isCoverageMode </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 5× for coverage, 2× normally</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: Performance tests need coverage-aware tolerances.</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="5-checkpoint-config-hash-validation-enrich--t06">5. <strong>Checkpoint Config Hash Validation</strong> (ENRICH--T06)<a href="#5-checkpoint-config-hash-validation-enrich--t06" class="hash-link" aria-label="Direct link to 5-checkpoint-config-hash-validation-enrich--t06" title="Direct link to 5-checkpoint-config-hash-validation-enrich--t06" translate="no">​</a></h4>
<p><strong>Issue</strong>: Resuming with different config silently produced inconsistent
results.</p>
<p><strong>Solution</strong>: SHA-256 hash of config stored in checkpoint, verified on resume.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">computeConfigHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EnrichConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> crypto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;sha256&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">digest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;hex&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">verifyConfigHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">checkpoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currentConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> checkpoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">configHash </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">computeConfigHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: Checkpoints must validate config consistency to prevent silent
corruption.</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="6-deterministic-sorting-edge-case-render--t04">6. <strong>Deterministic Sorting Edge Case</strong> (RENDER--T04)<a href="#6-deterministic-sorting-edge-case-render--t04" class="hash-link" aria-label="Direct link to 6-deterministic-sorting-edge-case-render--t04" title="Direct link to 6-deterministic-sorting-edge-case-render--t04" translate="no">​</a></h4>
<p><strong>Issue</strong>: Messages with identical timestamps had non-deterministic ordering
across runs.</p>
<p><strong>Solution</strong>: Secondary sort by GUID when timestamps match.</p>
<div class="language-typescript codeBlockContainer_Cu7V theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_aj1M"><pre tabindex="0" class="prism-code language-typescript codeBlock_ri4f thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_G9qo"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ❌ Before: Non-deterministic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ✅ After: Deterministic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dateComp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dateComp </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dateComp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">guid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">localeCompare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">guid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Secondary sort by GUID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Lesson</strong>: Always have a tiebreaker for sort stability.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="testing-strategy">Testing Strategy<a href="#testing-strategy" class="hash-link" aria-label="Direct link to Testing Strategy" title="Direct link to Testing Strategy" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="tdd-approach-high-risk-tasks">TDD Approach (High-Risk Tasks)<a href="#tdd-approach-high-risk-tasks" class="hash-link" aria-label="Direct link to TDD Approach (High-Risk Tasks)" title="Direct link to TDD Approach (High-Risk Tasks)" translate="no">​</a></h4>
<p>All HIGH risk tasks used strict Red-Green-Refactor TDD:</p>
<ul>
<li class="">NORMALIZE--T03 (Reply/tapback linking): 23 tests before implementation</li>
<li class="">NORMALIZE--T04 (Deduplication): 30 tests, 83% branch coverage</li>
<li class="">NORMALIZE--T06 (Date conversion): 339 tests including DST/leap seconds</li>
<li class="">ENRICH--T01 (Image analysis): 32 tests, 100% branch coverage</li>
<li class="">ENRICH--T04 (Link enrichment): 88 tests, full error path coverage</li>
<li class="">ENRICH--T05 (Idempotency): 30 tests, 92% branch coverage</li>
<li class="">RENDER--T04 (Determinism): 31 tests including performance validation</li>
</ul>
<p><strong>Result</strong>: Zero production bugs in high-risk areas.</p>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="wallaby-js-integration">Wallaby JS Integration<a href="#wallaby-js-integration" class="hash-link" aria-label="Direct link to Wallaby JS Integration" title="Direct link to Wallaby JS Integration" translate="no">​</a></h4>
<p>Used Wallaby JS for real-time test feedback during development:</p>
<ul>
<li class="">Instant test execution on file save</li>
<li class="">Inline coverage indicators in editor</li>
<li class="">Red/green feedback loop &lt; 1 second</li>
<li class="">Dramatically improved TDD velocity</li>
</ul>
<p><strong>Lesson</strong>: Live test runners are invaluable for TDD workflows.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="rendering-performance-render--t04">Rendering Performance (RENDER--T04)<a href="#rendering-performance-render--t04" class="hash-link" aria-label="Direct link to Rendering Performance (RENDER--T04)" title="Direct link to Rendering Performance (RENDER--T04)" translate="no">​</a></h4>
<p>Measured on Apple Silicon M1:</p>
<table><thead><tr><th>Message Count</th><th>Render Time</th><th>Per Message</th></tr></thead><tbody><tr><td>10</td><td>10ms</td><td>1.0ms</td></tr><tr><td>100</td><td>3ms</td><td>0.03ms</td></tr><tr><td>500</td><td>25ms</td><td>0.05ms</td></tr><tr><td>1000</td><td>69ms</td><td>0.069ms</td></tr></tbody></table>
<p><strong>Observation</strong>: Sub-linear scaling due to efficient grouping algorithms.</p>
<p><strong>Spec Requirement</strong>: <code>&lt;10s</code> for 1000 messages ✅ (actual: 69ms, 145× faster)</p>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="test-suite-performance">Test Suite Performance<a href="#test-suite-performance" class="hash-link" aria-label="Direct link to Test Suite Performance" title="Direct link to Test Suite Performance" translate="no">​</a></h4>
<ul>
<li class=""><strong>Unit tests</strong>: 764 tests in 1.53s (~2ms per test)</li>
<li class=""><strong>With coverage</strong>: 3.90s (~5ms per test)</li>
<li class=""><strong>Coverage overhead</strong>: ~2.55× slower (acceptable)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="remaining-work-e6-documentation">Remaining Work (E6: Documentation)<a href="#remaining-work-e6-documentation" class="hash-link" aria-label="Direct link to Remaining Work (E6: Documentation)" title="Direct link to Remaining Work (E6: Documentation)" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="docs--t01-refactor-report-update--in-progress">DOCS--T01: Refactor Report Update ⏳ (In Progress)<a href="#docs--t01-refactor-report-update--in-progress" class="hash-link" aria-label="Direct link to DOCS--T01: Refactor Report Update ⏳ (In Progress)" title="Direct link to DOCS--T01: Refactor Report Update ⏳ (In Progress)" translate="no">​</a></h4>
<ul>
<li class="">Document implementation deltas ✅</li>
<li class="">Update architecture diagrams (if needed)</li>
<li class="">Capture lessons learned ✅</li>
<li class="">Link to all new files ✅</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="docs--t02-usage-documentation-pending">DOCS--T02: Usage Documentation (Pending)<a href="#docs--t02-usage-documentation-pending" class="hash-link" aria-label="Direct link to DOCS--T02: Usage Documentation (Pending)" title="Direct link to DOCS--T02: Usage Documentation (Pending)" translate="no">​</a></h4>
<ul>
<li class="">How to run each stage</li>
<li class="">End-to-end workflow example</li>
<li class="">Configuration guide</li>
<li class="">Environment setup</li>
<li class="">CLI reference</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="docs--t03-troubleshooting-guide-pending">DOCS--T03: Troubleshooting Guide (Pending)<a href="#docs--t03-troubleshooting-guide-pending" class="hash-link" aria-label="Direct link to DOCS--T03: Troubleshooting Guide (Pending)" title="Direct link to DOCS--T03: Troubleshooting Guide (Pending)" translate="no">​</a></h4>
<ul>
<li class="">Date/timezone issues</li>
<li class="">Missing media files</li>
<li class="">Rate limiting</li>
<li class="">Checkpoint failures</li>
<li class="">Validation errors</li>
</ul>
<p><strong>Estimated</strong>: 3-4 days to complete all documentation tasks.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="key-achievements">Key Achievements<a href="#key-achievements" class="hash-link" aria-label="Direct link to Key Achievements" title="Direct link to Key Achievements" translate="no">​</a></h3>
<ol>
<li class="">
<p><strong>✅ Separation of Concerns</strong></p>
<ul>
<li class="">Clean boundaries between ingest, normalize, enrich, render</li>
<li class="">No circular dependencies</li>
<li class="">Each stage independently testable</li>
</ul>
</li>
<li class="">
<p><strong>✅ Type Safety</strong></p>
<ul>
<li class="">Full TypeScript coverage</li>
<li class="">Zod runtime validation</li>
<li class="">No <code>any</code> types in production code</li>
</ul>
</li>
<li class="">
<p><strong>✅ Resilience</strong></p>
<ul>
<li class="">Idempotent enrichment (re-run safe)</li>
<li class="">Checkpointing with resume support</li>
<li class="">Rate limiting with exponential backoff</li>
<li class="">Circuit breaker prevents cascading failures</li>
</ul>
</li>
<li class="">
<p><strong>✅ Determinism</strong></p>
<ul>
<li class="">Identical output for identical input</li>
<li class="">Stable sorting, stable IDs</li>
<li class="">SHA-256 hashing verification</li>
</ul>
</li>
<li class="">
<p><strong>✅ Test Coverage</strong></p>
<ul>
<li class="">81.41% branch coverage (exceeds 70% spec)</li>
<li class="">764 tests, 100% passing</li>
<li class="">Comprehensive test helpers for future development</li>
</ul>
</li>
<li class="">
<p><strong>✅ Performance</strong></p>
<ul>
<li class="">145× faster than spec requirement for rendering</li>
<li class="">Sub-linear scaling for large datasets</li>
<li class="">Efficient enrichment with caching</li>
</ul>
</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="migration-from-legacy-scripts">Migration from Legacy Scripts<a href="#migration-from-legacy-scripts" class="hash-link" aria-label="Direct link to Migration from Legacy Scripts" title="Direct link to Migration from Legacy Scripts" translate="no">​</a></h3>
<p><strong>Status</strong>: Original scripts preserved for reference but superseded by new
pipeline.</p>
<p><strong>Original Scripts</strong> (now legacy):</p>
<ul>
<li class=""><code>.scripts/convert-csv-to-json.mjs</code> → Replaced by <code>src/ingest/ingest-csv.ts</code></li>
<li class=""><code>.scripts/export-imessages-json.mjs</code> → Replaced by <code>src/ingest/ingest-db.ts</code></li>
<li class=""><code>.scripts/analyze-messages-json.mjs</code> → Split into <code>src/enrich/</code> and
<code>src/render/</code></li>
</ul>
<p><strong>Migration Path</strong>:</p>
<ol>
<li class="">Run new pipeline side-by-side with old scripts</li>
<li class="">Compare outputs (visual diff + validation)</li>
<li class="">Cut over when confidence is high</li>
<li class="">Archive legacy scripts to <code>.scripts/legacy/</code></li>
</ol>
<p><strong>Current Status</strong>: New pipeline operational, legacy scripts retained for
historical reference.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_fz2_" id="conclusions--recommendations">Conclusions &amp; Recommendations<a href="#conclusions--recommendations" class="hash-link" aria-label="Direct link to Conclusions &amp; Recommendations" title="Direct link to Conclusions &amp; Recommendations" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="what-went-well">What Went Well<a href="#what-went-well" class="hash-link" aria-label="Direct link to What Went Well" title="Direct link to What Went Well" translate="no">​</a></h4>
<ol>
<li class=""><strong>Modular Architecture</strong> - Clean separation enabled parallel development and
isolated testing</li>
<li class=""><strong>TDD Discipline</strong> - Zero production bugs in high-risk areas</li>
<li class=""><strong>Type Safety</strong> - Zod + TypeScript caught issues at development time, not
runtime</li>
<li class=""><strong>Test Helpers</strong> - Reusable utilities accelerated test development
significantly</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="what-could-be-improved">What Could Be Improved<a href="#what-could-be-improved" class="hash-link" aria-label="Direct link to What Could Be Improved" title="Direct link to What Could Be Improved" translate="no">​</a></h4>
<ol>
<li class=""><strong>Earlier Fixture Strategy</strong> - Should have created <code>tests/helpers/</code> earlier
in project</li>
<li class=""><strong>Checkpoint Format</strong> - JSON is readable but not space-efficient; consider
MessagePack for large datasets</li>
<li class=""><strong>Performance Testing</strong> - Add CI performance benchmarks to catch regressions
early</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_fz2_" id="next-steps-beyond-e6">Next Steps (Beyond E6)<a href="#next-steps-beyond-e6" class="hash-link" aria-label="Direct link to Next Steps (Beyond E6)" title="Direct link to Next Steps (Beyond E6)" translate="no">​</a></h4>
<ol>
<li class=""><strong>CLI Development</strong> - Complete <code>src/cli.ts</code> with full command-line interface</li>
<li class=""><strong>Configuration File</strong> - YAML/JSON config for attachment roots, rate limits,
etc.</li>
<li class=""><strong>Progress UI</strong> - Terminal progress bars for long-running enrichment</li>
<li class=""><strong>Incremental Enrichment</strong> - Only process new messages (delta mode)</li>
<li class=""><strong>Web UI</strong> - Optional web interface for browsing enriched messages</li>
</ol>
<hr>
<p><strong>Document Version</strong>: 2.0<br>
<strong>Implementation Period</strong>: October 15-19, 2025<br>
<strong>Total Development Time</strong>: ~5 days (93% complete)<br>
<strong>Final Status</strong>: Production-ready pipeline, documentation in progress</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_XlAX"><a href="https://github.com/nathanvale/imessage-timeline/tree/main/website/docs/imessage-pipeline-refactor-report.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mVSc" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_jnZY"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/imessage-timeline/docs/imessage-pipeline-implementation-summary"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">iMessage Pipeline Implementation Summary</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/imessage-timeline/docs/imessage-pipeline-tasks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">iMessage Pipeline Implementation Tasks</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_J9fL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#executive-summary" class="table-of-contents__link toc-highlight">executive summary</a></li><li><a href="#target-architecture-four-stage-pipeline" class="table-of-contents__link toc-highlight">target architecture (four-stage pipeline)</a><ul><li><a href="#stage-1--ingest" class="table-of-contents__link toc-highlight">stage 1 — ingest</a></li><li><a href="#stage-2--normalize--link" class="table-of-contents__link toc-highlight">stage 2 — normalize &amp; link</a></li><li><a href="#stage-3--enrich-ai-only" class="table-of-contents__link toc-highlight">stage 3 — enrich (AI only)</a></li><li><a href="#stage-4--render-markdown-only" class="table-of-contents__link toc-highlight">stage 4 — render (markdown only)</a></li></ul></li><li><a href="#what-the-current-analyzer-already-does-well-to-preserve" class="table-of-contents__link toc-highlight">what the current analyzer already does well (to preserve)</a></li><li><a href="#unified-json-schema-typescript--zod" class="table-of-contents__link toc-highlight">unified JSON schema (TypeScript + Zod)</a><ul><li><a href="#schema-notes" class="table-of-contents__link toc-highlight">schema notes</a></li></ul></li><li><a href="#csv-output-compatibility--mapping" class="table-of-contents__link toc-highlight">CSV output compatibility &amp; mapping</a></li><li><a href="#db-exporter-drift--mapping" class="table-of-contents__link toc-highlight">DB exporter drift &amp; mapping</a><ul><li><a href="#current-shape-db" class="table-of-contents__link toc-highlight">current shape (db)</a></li><li><a href="#desired-shape-aligned" class="table-of-contents__link toc-highlight">desired shape (aligned)</a></li><li><a href="#grouping-and-guids" class="table-of-contents__link toc-highlight">grouping and guids</a></li><li><a href="#field-mappings-db--unified-schema" class="table-of-contents__link toc-highlight">field mappings (db → unified schema)</a></li><li><a href="#algorithm-db-split" class="table-of-contents__link toc-highlight">algorithm (db split)</a></li></ul></li><li><a href="#linking--deduplication-strategy" class="table-of-contents__link toc-highlight">linking &amp; deduplication strategy</a><ul><li><a href="#identifiers" class="table-of-contents__link toc-highlight">identifiers</a></li><li><a href="#deduplication" class="table-of-contents__link toc-highlight">deduplication</a></li><li><a href="#reply-linking" class="table-of-contents__link toc-highlight">reply linking</a></li><li><a href="#tapback-linking" class="table-of-contents__link toc-highlight">tapback linking</a></li><li><a href="#reply-threading-parity-csv--db" class="table-of-contents__link toc-highlight">reply threading parity (CSV ↔ DB)</a></li><li><a href="#media-normalization" class="table-of-contents__link toc-highlight">media normalization</a></li></ul></li><li><a href="#performance-resilience-and-resumability" class="table-of-contents__link toc-highlight">performance, resilience, and resumability</a></li><li><a href="#file-layout--tooling" class="table-of-contents__link toc-highlight">file layout &amp; tooling</a><ul><li><a href="#packagejson-scripts-pnpm" class="table-of-contents__link toc-highlight">package.json scripts (pnpm)</a></li></ul></li><li><a href="#security--privacy" class="table-of-contents__link toc-highlight">security &amp; privacy</a></li><li><a href="#dates--timezones" class="table-of-contents__link toc-highlight">dates &amp; timezones</a><ul><li><a href="#csv-source" class="table-of-contents__link toc-highlight">CSV source</a></li><li><a href="#db-source" class="table-of-contents__link toc-highlight">DB source</a></li><li><a href="#invariants-and-validation" class="table-of-contents__link toc-highlight">invariants and validation</a></li><li><a href="#ordering-and-grouping" class="table-of-contents__link toc-highlight">ordering and grouping</a></li><li><a href="#display-vs-storage" class="table-of-contents__link toc-highlight">display vs storage</a></li></ul></li><li><a href="#media-path-resolution--provenance" class="table-of-contents__link toc-highlight">media path resolution &amp; provenance</a><ul><li><a href="#csv-resolver-imazing-backups" class="table-of-contents__link toc-highlight">CSV resolver (iMazing backups)</a></li><li><a href="#db-resolver-messages-attachments" class="table-of-contents__link toc-highlight">DB resolver (Messages attachments)</a></li><li><a href="#policy--validation" class="table-of-contents__link toc-highlight">policy &amp; validation</a></li></ul></li><li><a href="#testing--ci-vitest" class="table-of-contents__link toc-highlight">testing &amp; CI (Vitest)</a></li><li><a href="#migration-plan" class="table-of-contents__link toc-highlight">migration plan</a></li><li><a href="#risks--mitigations" class="table-of-contents__link toc-highlight">risks &amp; mitigations</a></li><li><a href="#timeline-suggested" class="table-of-contents__link toc-highlight">timeline (suggested)</a></li><li><a href="#appendix-a--example-json-enriched" class="table-of-contents__link toc-highlight">appendix A — example JSON (enriched)</a></li><li><a href="#appendix-b--cli-surface-proposed" class="table-of-contents__link toc-highlight">appendix B — CLI surface (proposed)</a></li><li><a href="#completion-summary" class="table-of-contents__link toc-highlight">completion summary</a></li><li><a href="#appendix-c--csv-converter-deep-dive-domains-gaps-improvements" class="table-of-contents__link toc-highlight">appendix C — CSV converter deep-dive: domains, gaps, improvements</a><ul><li><a href="#domains-covered-well-today" class="table-of-contents__link toc-highlight">domains covered well today</a></li><li><a href="#notable-gaps-or-risks" class="table-of-contents__link toc-highlight">notable gaps or risks</a></li><li><a href="#parity-requirements-for-db-path" class="table-of-contents__link toc-highlight">parity requirements for DB path</a></li><li><a href="#low-risk-enhancements" class="table-of-contents__link toc-highlight">low-risk enhancements</a></li></ul></li><li><a href="#implementation-report-october-2025" class="table-of-contents__link toc-highlight">Implementation Report (October 2025)</a><ul><li><a href="#implementation-overview" class="table-of-contents__link toc-highlight">Implementation Overview</a></li><li><a href="#architecture-deltas-from-original-plan" class="table-of-contents__link toc-highlight">Architecture Deltas from Original Plan</a></li><li><a href="#file-structure-as-implemented" class="table-of-contents__link toc-highlight">File Structure (As Implemented)</a></li><li><a href="#lessons-learned--implementation-gotchas" class="table-of-contents__link toc-highlight">Lessons Learned &amp; Implementation Gotchas</a></li><li><a href="#testing-strategy" class="table-of-contents__link toc-highlight">Testing Strategy</a></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a></li><li><a href="#remaining-work-e6-documentation" class="table-of-contents__link toc-highlight">Remaining Work (E6: Documentation)</a></li><li><a href="#key-achievements" class="table-of-contents__link toc-highlight">Key Achievements</a></li><li><a href="#migration-from-legacy-scripts" class="table-of-contents__link toc-highlight">Migration from Legacy Scripts</a></li><li><a href="#conclusions--recommendations" class="table-of-contents__link toc-highlight">Conclusions &amp; Recommendations</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/imessage-timeline/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/imessage-timeline/docs/cli-usage">CLI Usage</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Project</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nathanvale/imessage-timeline" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_h_1J"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.npmjs.com/package/imessage-timeline" target="_blank" rel="noopener noreferrer" class="footer__link-item">npm Package<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_h_1J"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/imessage-timeline/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/imessage-timeline/docs/releases/changesets-canonical">Release Notes</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Nathan Vale. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>