"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2165],{2340:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"testing-best-practices","title":"Testing best practices (Vitest + Testing Library + Wallaby)","description":"This project uses Vitest for unit/integration tests with a jsdom environment,","source":"@site/docs/testing-best-practices.md","sourceDirName":".","slug":"/testing-best-practices","permalink":"/chatline/docs/testing-best-practices","draft":false,"unlisted":false,"editUrl":"https://github.com/nathanvale/chatline/tree/main/website/docs/testing-best-practices.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Test Configuration Best Practices Research","permalink":"/chatline/docs/test-configuration-research"},"next":{"title":"Vitest + Firecrawl ESM & Bun Best Practices for CLI Projects","permalink":"/chatline/docs/vitest-firecrawl-esm-bun-best-practices"}}');var t=n(6801),r=n(5705);const l={},c="Testing best practices (Vitest + Testing Library + Wallaby)",d={},a=[{value:"Determinism and order",id:"determinism-and-order",level:2},{value:"Deterministic date handling (UTC)",id:"deterministic-date-handling-utc",level:3},{value:"Isolation and hygiene",id:"isolation-and-hygiene",level:2},{value:"Async UI assertions (if/when testing React)",id:"async-ui-assertions-ifwhen-testing-react",level:2},{value:"Coverage policy",id:"coverage-policy",level:2},{value:"CI behavior",id:"ci-behavior",level:2},{value:"jsdom environment notes",id:"jsdom-environment-notes",level:2},{value:"Wallaby tips (optional local TDD)",id:"wallaby-tips-optional-local-tdd",level:2},{value:"Quick checklist",id:"quick-checklist",level:2}];function o(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"testing-best-practices-vitest--testing-library--wallaby",children:"Testing best practices (Vitest + Testing Library + Wallaby)"})}),"\n",(0,t.jsx)(s.p,{children:"This project uses Vitest for unit/integration tests with a jsdom environment,\nplus optional Wallaby for fast, in-editor feedback. This guide captures the\nrationale behind our config and the patterns we use to keep tests reliable,\nreadable, and fast."}),"\n",(0,t.jsx)(s.h2,{id:"determinism-and-order",children:"Determinism and order"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Shuffle test execution to uncover hidden state coupling","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Enabled via ",(0,t.jsx)(s.code,{children:"test.sequence.shuffle = true"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Use a stable seed in CI for reproducible runs","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"test.sequence.seed = 20251111"})," when ",(0,t.jsx)(s.code,{children:"TF_BUILD"})," is set"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"Prefer isolated tests; avoid reliance on execution order"}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"deterministic-date-handling-utc",children:"Deterministic date handling (UTC)"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Treat timezone-less ISO strings as UTC and append ",(0,t.jsx)(s.code,{children:"Z"})," before parsing","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Canonicalize with ",(0,t.jsx)(s.code,{children:"new Date(iso).toISOString()"})," to normalize output"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Use UTC getters (",(0,t.jsx)(s.code,{children:"getUTCHours"}),", ",(0,t.jsx)(s.code,{children:"getUTCFullYear"}),", etc.) consistently"]}),"\n",(0,t.jsxs)(s.li,{children:["Prefer lexicographic sorting for date-only keys (",(0,t.jsx)(s.code,{children:"YYYY-MM-DD"}),") to avoid\nenvironment-dependent parsing"]}),"\n",(0,t.jsxs)(s.li,{children:["Enforce ",(0,t.jsx)(s.code,{children:"process.env.TZ = 'UTC'"})," in ",(0,t.jsx)(s.code,{children:"tests/vitest/vitest-setup.ts"})]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Note: We normalize timezone-less ISO strings by appending ",(0,t.jsx)(s.code,{children:"Z"})," and then\ncanonicalizing with ",(0,t.jsx)(s.code,{children:"toISOString()"}),". This guarantees UTC interpretation and\nprevents environment-dependent parsing. Grouping utilities and render logic\napply this normalization before any date math or comparisons."]}),"\n",(0,t.jsx)(s.p,{children:"References: Vitest sequence docs (shuffle/seed), reporters and CI usage."}),"\n",(0,t.jsx)(s.h2,{id:"isolation-and-hygiene",children:"Isolation and hygiene"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["No globals: ",(0,t.jsx)(s.code,{children:"test.globals = false"}),"; import what you use"]}),"\n",(0,t.jsxs)(s.li,{children:["Global setup (",(0,t.jsx)(s.code,{children:"tests/vitest/vitest-setup.ts"}),"):","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"vi.resetAllMocks()"}),", ",(0,t.jsx)(s.code,{children:"vi.clearAllMocks()"})," in ",(0,t.jsx)(s.code,{children:"beforeEach"})]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"vi.useRealTimers()"})," to avoid timer leakage"]}),"\n",(0,t.jsxs)(s.li,{children:["Register matchers with Vitest-friendly import:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"import '@testing-library/jest-dom/vitest'"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Raise listener limit to avoid EventEmitter warnings in parallel runs:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"process.setMaxListeners(64)"})}),"\n",(0,t.jsx)(s.li,{children:"Rationale: multiple suites attach process-level listeners (e.g., SIGINT,\nSIGTERM) under parallel execution. Raising the cap removes noisy\nMaxListeners warnings without masking legitimate errors."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"Prefer module-level pure helpers over process-level shared state"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"References: jest-dom \u201cWith Vitest\u201d usage notes."}),"\n",(0,t.jsx)(s.h2,{id:"async-ui-assertions-ifwhen-testing-react",children:"Async UI assertions (if/when testing React)"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Use ",(0,t.jsx)(s.code,{children:"screen"})," queries from Testing Library"]}),"\n",(0,t.jsxs)(s.li,{children:["Prefer ",(0,t.jsx)(s.code,{children:"findBy*"})," (auto-retrying) for async UI instead of manual timeouts"]}),"\n",(0,t.jsxs)(s.li,{children:["Use ",(0,t.jsx)(s.code,{children:"waitFor(...)"})," to wrap stateful async updates when needed"]}),"\n",(0,t.jsxs)(s.li,{children:["Prefer ",(0,t.jsx)(s.code,{children:"userEvent"})," over ",(0,t.jsx)(s.code,{children:"fireEvent"})," for realistic interactions"]}),"\n",(0,t.jsxs)(s.li,{children:["Query by role/name first; fall back to ",(0,t.jsx)(s.code,{children:"getByTestId"})," only when necessary"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"References: React Testing Library cheatsheet (queries, async, events)."}),"\n",(0,t.jsx)(s.h2,{id:"coverage-policy",children:"Coverage policy"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Provider: ",(0,t.jsx)(s.code,{children:"v8"})]}),"\n",(0,t.jsxs)(s.li,{children:["Thresholds (global + per-file):","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"branches: 75"}),"\n",(0,t.jsx)(s.li,{children:"lines/functions/statements: 80"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["Reports:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Local: ",(0,t.jsx)(s.code,{children:"html"})," + ",(0,t.jsx)(s.code,{children:"text-summary"})," \u2192 ",(0,t.jsx)(s.code,{children:"./coverage"})]}),"\n",(0,t.jsxs)(s.li,{children:["CI: ",(0,t.jsx)(s.code,{children:"html"}),", ",(0,t.jsx)(s.code,{children:"lcov"}),", ",(0,t.jsx)(s.code,{children:"text-summary"})," \u2192 ",(0,t.jsx)(s.code,{children:"./test-results/coverage"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"Exclusions: type defs, test files, build outputs, config files"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"References: Vitest coverage config and reporters."}),"\n",(0,t.jsx)(s.h2,{id:"ci-behavior",children:"CI behavior"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Reporters: ",(0,t.jsx)(s.code,{children:"default"})," locally; ",(0,t.jsx)(s.code,{children:"['junit', 'default']"})," in CI","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["JUnit output: ",(0,t.jsx)(s.code,{children:"./test-results/junit.xml"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"Concurrency: threads pool, capped at 8 workers"}),"\n",(0,t.jsxs)(s.li,{children:["Determinism: stable seed and ",(0,t.jsx)(s.code,{children:"allowOnly = false"})]}),"\n",(0,t.jsxs)(s.li,{children:["Retries: enabled only in CI (",(0,t.jsx)(s.code,{children:"retry = 2"}),") for transient flake"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Standard CI env is exported via the composite action\n",(0,t.jsx)(s.code,{children:"./.github/actions/standard-ci-env"}),", which sets ",(0,t.jsx)(s.code,{children:"TZ=UTC"})," and ",(0,t.jsx)(s.code,{children:"TF_BUILD=true"}),"\nbefore running installs/build/tests. This keeps CI output and snapshot behavior\nconsistent across jobs."]}),"\n",(0,t.jsx)(s.p,{children:"References: Vitest reporters, sequence, retries."}),"\n",(0,t.jsx)(s.h2,{id:"jsdom-environment-notes",children:"jsdom environment notes"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["No real layout/rendering; APIs like ",(0,t.jsx)(s.code,{children:"getBoundingClientRect()"})," may be zeroed"]}),"\n",(0,t.jsx)(s.li,{children:"Use role/name-based queries; avoid layout expectations"}),"\n",(0,t.jsxs)(s.li,{children:["If you need ",(0,t.jsx)(s.code,{children:"requestAnimationFrame"}),", jsdom can simulate it; but we avoid\nenabling ",(0,t.jsx)(s.code,{children:"pretendToBeVisual"})," to keep runs lean"]}),"\n",(0,t.jsx)(s.li,{children:"Avoid global window mutation; prefer dependency injection"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"References: jsdom README (caveats, pretendToBeVisual, executing scripts)."}),"\n",(0,t.jsx)(s.h2,{id:"wallaby-tips-optional-local-tdd",children:"Wallaby tips (optional local TDD)"}),"\n",(0,t.jsx)(s.p,{children:"Wallaby auto-detects Vitest config. If you add a manual config, prefer:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"autoDetect: ['vitest']"})," (or leave auto detection on)"]}),"\n",(0,t.jsxs)(s.li,{children:["Keep workers small while starting (",(0,t.jsx)(s.code,{children:"workers: 1\u20132"}),") if you see flake"]}),"\n",(0,t.jsxs)(s.li,{children:["If transient issues occur, try ",(0,t.jsx)(s.code,{children:"workers.restart = true"})]}),"\n",(0,t.jsx)(s.li,{children:"Exclude large folders from instrumentation (dist, coverage, caches)"}),"\n",(0,t.jsx)(s.li,{children:"Use the Wallaby Troubleshooting guide for stuck cache or core updates"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"References: Wallaby overview, auto-detect, workers, troubleshooting."}),"\n",(0,t.jsx)(s.h2,{id:"quick-checklist",children:"Quick checklist"}),"\n",(0,t.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Use ",(0,t.jsx)(s.code,{children:"screen"})," queries; prefer ",(0,t.jsx)(s.code,{children:"findBy*"})," for async"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Reset/clear mocks and real timers in ",(0,t.jsx)(s.code,{children:"beforeEach"})]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Avoid global state and implicit test ordering"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Don\u2019t assert on DOM structure; assert on behavior and accessible roles"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Keep coverage thresholds green; raise on critical paths when feasible"]}),"\n",(0,t.jsxs)(s.li,{className:"task-list-item",children:[(0,t.jsx)(s.input,{type:"checkbox",disabled:!0})," ","In CI, keep runs reproducible (seed, junit, capped threads)"]}),"\n"]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.p,{children:"Further reading:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"React Testing Library: queries, async, and patterns"}),"\n",(0,t.jsx)(s.li,{children:"@testing-library/jest-dom: matchers and Vitest setup"}),"\n",(0,t.jsx)(s.li,{children:"jsdom: environment options, limitations, and safety"}),"\n",(0,t.jsx)(s.li,{children:"Wallaby: configuration, workers, and troubleshooting"}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},5705:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>c});var i=n(7701);const t={},r=i.createContext(t);function l(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);