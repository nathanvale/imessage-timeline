"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6314],{5705:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var i=s(7701);const c={},t=i.createContext(c);function r(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),i.createElement(t.Provider,{value:n},e.children)}},6127:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"ci-pnpm-caching","title":"CI pnpm Caching Strategy","description":"This project uses a layered caching approach to minimize install time across all","source":"@site/docs/ci-pnpm-caching.md","sourceDirName":".","slug":"/ci-pnpm-caching","permalink":"/chatline/docs/ci-pnpm-caching","draft":false,"unlisted":false,"editUrl":"https://github.com/nathanvale/chatline/tree/main/website/docs/ci-pnpm-caching.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"bun-single-repo-best-practices","permalink":"/chatline/docs/bun-single-repo-best-practices"},"next":{"title":"CI workflow standards","permalink":"/chatline/docs/ci-workflow-standards"}}');var c=s(6801),t=s(5705);const r={},a="CI pnpm Caching Strategy",l={},d=[{value:"Goals",id:"goals",level:2},{value:"Layers",id:"layers",level:2},{value:"Pattern",id:"pattern",level:2},{value:"Key Design Choices",id:"key-design-choices",level:2},{value:"When to Bust Cache Manually",id:"when-to-bust-cache-manually",level:2},{value:"Known Trade-offs",id:"known-trade-offs",level:2},{value:"Extending the Pattern",id:"extending-the-pattern",level:2},{value:"Composite action shortcut (preferred)",id:"composite-action-shortcut-preferred",level:2},{value:"Security Notes",id:"security-notes",level:2},{value:"Maintenance Checklist",id:"maintenance-checklist",level:2},{value:"Related Files",id:"related-files",level:2},{value:"Future Enhancements",id:"future-enhancements",level:2}];function o(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"ci-pnpm-caching-strategy",children:"CI pnpm Caching Strategy"})}),"\n",(0,c.jsx)(n.p,{children:"This project uses a layered caching approach to minimize install time across all\nGitHub Actions workflows while keeping security and determinism."}),"\n",(0,c.jsx)(n.h2,{id:"goals",children:"Goals"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Reproducible installs (lockfile + exact Node version via ",(0,c.jsx)(n.code,{children:".nvmrc"}),")"]}),"\n",(0,c.jsx)(n.li,{children:"Fast cold + warm starts across parallel jobs"}),"\n",(0,c.jsx)(n.li,{children:"Minimal cache invalidation surface (only bust when Node version or dependency\ngraph changes)"}),"\n",(0,c.jsx)(n.li,{children:"Immutable, pinned third-party actions for supply-chain safety"}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"layers",children:"Layers"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Corepack + packageManager"}),": ",(0,c.jsx)(n.code,{children:"corepack enable"})," respects\n",(0,c.jsx)(n.code,{children:"packageManager: pnpm@<version>"})," in ",(0,c.jsx)(n.code,{children:"package.json"})," for deterministic pnpm\nversion."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"setup-node built-in cache"}),": Each job sets ",(0,c.jsx)(n.code,{children:"cache: 'pnpm'"})," (where\nmeaningful) to leverage built-in caching keyed by the lockfile hash."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Explicit pnpm store cache (actions/cache)"}),": Adds cross-job +\ncross-workflow reuse of the pnpm store with a custom key to avoid duplicate\nextraction."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"pattern",children:"Pattern"}),"\n",(0,c.jsx)(n.p,{children:"Each workflow job that installs dependencies follows this sequence (after\ncheckout & Node setup):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:"- name: Enable Corepack (pnpm)\n  run: corepack enable\n\n- uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0\n  with:\n    run_install: false\n\n- name: Get pnpm store path\n  id: pnpm-store\n  run: echo \"PNPM_STORE_PATH=$(pnpm store path --silent)\" >> $GITHUB_ENV\n\n- name: Cache pnpm store\n  uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0\n  with:\n    path: ${{ env.PNPM_STORE_PATH }}\n    key:\n      pnpm-store-${{ runner.os }}-${{ hashFiles('.nvmrc') }}-${{\n      hashFiles('pnpm-lock.yaml') }}\n    restore-keys: |\n      pnpm-store-${{ runner.os }}-${{ hashFiles('.nvmrc') }}-\n\n- name: Install dependencies\n  run: pnpm install --frozen-lockfile\n"})}),"\n",(0,c.jsx)(n.h2,{id:"key-design-choices",children:"Key Design Choices"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Aspect"}),(0,c.jsx)(n.th,{children:"Rationale"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:".nvmrc"})}),(0,c.jsx)(n.td,{children:"Unifies Node across dev & CI; forms part of cache key."})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"hashFiles('pnpm-lock.yaml')"})}),(0,c.jsx)(n.td,{children:"Busts cache when dependency graph changes."})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"hashFiles('.nvmrc')"})}),(0,c.jsx)(n.td,{children:"Ensures cache isolation per Node major/minor changes."})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsxs)(n.td,{children:[(0,c.jsx)(n.code,{children:"restore-keys"})," prefix"]}),(0,c.jsx)(n.td,{children:"Allows fallback to previous lockfile cache if only small changes occur (best-effort reuse)."})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsxs)(n.td,{children:[(0,c.jsx)(n.code,{children:"run_install: false"})," on pnpm/action-setup"]}),(0,c.jsx)(n.td,{children:"Lets us control install timing after cache restore."})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Pinned SHAs"}),(0,c.jsx)(n.td,{children:"Eliminates supply-chain drift in CI infrastructure."})]})]})]}),"\n",(0,c.jsx)(n.h2,{id:"when-to-bust-cache-manually",children:"When to Bust Cache Manually"}),"\n",(0,c.jsx)(n.p,{children:"Normally automatic. Manually invalidate if:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Corrupt cache suspected (rare): update one character in ",(0,c.jsx)(n.code,{children:".nvmrc"})," then revert,\nor push an empty commit touching lockfile."]}),"\n",(0,c.jsxs)(n.li,{children:["Upgrading pnpm major version: update ",(0,c.jsx)(n.code,{children:"packageManager"})," field (will change store\nstructure => new key anyway)."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"known-trade-offs",children:"Known Trade-offs"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Adds a few extra seconds for the cache lookup step; net win when dependency\ninstall takes >10s."}),"\n",(0,c.jsxs)(n.li,{children:["Duplicate layer with ",(0,c.jsx)(n.code,{children:"cache: pnpm"})," is partly redundant but harmless; built-in\ncache may sometimes satisfy without hitting actions/cache. We favor redundancy\nfor reliability."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"extending-the-pattern",children:"Extending the Pattern"}),"\n",(0,c.jsx)(n.p,{children:"For language additions (e.g., Python tooling) keep caches orthogonal: avoid\nmixing paths in a single cache entry."}),"\n",(0,c.jsx)(n.h2,{id:"composite-action-shortcut-preferred",children:"Composite action shortcut (preferred)"}),"\n",(0,c.jsxs)(n.p,{children:["To keep workflows DRY, use the composite action that encapsulates the pattern\nabove, plus built-in caching and Node setup from ",(0,c.jsx)(n.code,{children:".nvmrc"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:"- name: Standard CI Env\n  uses: ./.github/actions/standard-ci-env\n\n- name: Setup pnpm toolchain\n  uses: ./.github/actions/setup-pnpm\n  with:\n    # Only needed for authenticated publish flows\n    registry-url: 'https://registry.npmjs.org'\n"})}),"\n",(0,c.jsxs)(n.p,{children:["This sets ",(0,c.jsx)(n.code,{children:"TZ=UTC"})," and ",(0,c.jsx)(n.code,{children:"TF_BUILD=true"}),", enables Corepack, installs pnpm,\nconfigures Node from ",(0,c.jsx)(n.code,{children:".nvmrc"}),", and caches the pnpm store keyed by ",(0,c.jsx)(n.code,{children:".nvmrc"})," and\n",(0,c.jsx)(n.code,{children:"pnpm-lock.yaml"}),"."]}),"\n",(0,c.jsx)(n.h2,{id:"security-notes",children:"Security Notes"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["All cache-producing steps run ",(0,c.jsx)(n.em,{children:"after"})," checkout but before arbitrary build\nscripts."]}),"\n",(0,c.jsx)(n.li,{children:"Only deterministic dependency artifacts stored. No secrets placed in cached\ndirectory."}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"maintenance-checklist",children:"Maintenance Checklist"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Keep action SHAs periodically refreshed (dependabot / manual audit)."}),"\n",(0,c.jsx)(n.li,{children:"Review cache hit/miss in workflow logs quarterly."}),"\n",(0,c.jsx)(n.li,{children:"If store format changes (pnpm release notes), ensure keys differentiate\n(Node/pnpm version combo already covers most cases)."}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"related-files",children:"Related Files"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:".nvmrc"})," \u2013 Node version anchor."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"package.json"})," \u2013 ",(0,c.jsx)(n.code,{children:"packageManager"})," field for pnpm version."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:".github/workflows/*.yml"})," \u2013 All relevant jobs updated."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Optional: Add a metrics step to log install duration and cache status (can\nfeed into a dashboard)."}),"\n",(0,c.jsx)(n.li,{children:"Optional: Introduce a weekly cache prime workflow if cold starts become\nfrequent."}),"\n"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.em,{children:"Last updated: 2025-11-12."})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(o,{...e})}):o(e)}}}]);