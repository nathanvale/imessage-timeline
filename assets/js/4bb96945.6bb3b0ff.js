"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[9792],{1009:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"imessage-pipeline-tech-spec","title":"iMessage pipeline \u2014 technical specification","description":"Detailed specification to implement the four-stage pipeline with a unified","source":"@site/docs/imessage-pipeline-tech-spec.md","sourceDirName":".","slug":"/imessage-pipeline-tech-spec","permalink":"/chatline/docs/imessage-pipeline-tech-spec","draft":false,"unlisted":false,"editUrl":"https://github.com/nathanvale/chatline/tree/main/website/docs/imessage-pipeline-tech-spec.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"iMessage Pipeline Implementation Tasks","permalink":"/chatline/docs/imessage-pipeline-tasks"},"next":{"title":"iMessage Pipeline Troubleshooting Guide","permalink":"/chatline/docs/imessage-pipeline-troubleshooting"}}');var l=n(6801),r=n(5705);const t={},d="iMessage pipeline \u2014 technical specification",c={},a=[{value:"1. scope &amp; goals",id:"1-scope--goals",level:2},{value:"non-goals",id:"non-goals",level:3},{value:"2. architecture overview",id:"2-architecture-overview",level:2},{value:"3. data model &amp; invariants",id:"3-data-model--invariants",level:2},{value:"schema",id:"schema",level:3},{value:"key invariants",id:"key-invariants",level:3},{value:"4. components &amp; CLIs",id:"4-components--clis",level:2},{value:"4.1 ingest-csv",id:"41-ingest-csv",level:3},{value:"4.2 ingest-db",id:"42-ingest-db",level:3},{value:"4.3 normalize-link",id:"43-normalize-link",level:3},{value:"4.4 enrich-ai",id:"44-enrich-ai",level:3},{value:"4.5 render-markdown",id:"45-render-markdown",level:3},{value:"5. configuration",id:"5-configuration",level:2},{value:"6. logging, errors, resiliency",id:"6-logging-errors-resiliency",level:2},{value:"7. security &amp; privacy",id:"7-security--privacy",level:2},{value:"8. performance",id:"8-performance",level:2},{value:"9. testing &amp; CI",id:"9-testing--ci",level:2},{value:"test areas",id:"test-areas",level:3},{value:"10. migration plan",id:"10-migration-plan",level:2},{value:"11. task decomposition",id:"11-task-decomposition",level:2},{value:"epics",id:"epics",level:3},{value:"detailed tasks",id:"detailed-tasks",level:3},{value:"12. acceptance criteria",id:"12-acceptance-criteria",level:2},{value:"13. risks &amp; mitigations",id:"13-risks--mitigations",level:2},{value:"14. milestones",id:"14-milestones",level:2}];function o(e){const i={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(i.header,{children:(0,l.jsx)(i.h1,{id:"imessage-pipeline--technical-specification",children:"iMessage pipeline \u2014 technical specification"})}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsx)(i.p,{children:"Detailed specification to implement the four-stage pipeline with a unified\nschema, enrichment, and deterministic rendering. Includes task breakdown,\nacceptance criteria, and risks."}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"1-scope--goals",children:"1. scope & goals"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Build a reliable, testable pipeline:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"ingest \u2192 normalize/link \u2192 enrich (AI) \u2192 render (markdown)"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.li,{children:"Unify schema with media-as-message (no attachments array)"}),"\n",(0,l.jsx)(i.li,{children:"Preserve analyzer strengths: transcription quality, image/PDF summaries, link\ncontext, previews, checkpoints, and readable markdown"}),"\n",(0,l.jsx)(i.li,{children:"Produce deterministic outputs that can be validated and reproduced"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"non-goals",children:"non-goals"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Replacing upstream export tools (iMazing, Messages DB)"}),"\n",(0,l.jsx)(i.li,{children:"Full video transcription or heavy video processing"}),"\n",(0,l.jsx)(i.li,{children:"Online publishing; outputs are local JSON + Markdown files"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"2-architecture-overview",children:"2. architecture overview"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Refer to ",(0,l.jsx)(i.code,{children:"documentation/imessage-pipeline-refactor-report.md"})," for the full\nnarrative and diagrams."]}),"\n",(0,l.jsxs)(i.li,{children:["Four-stage pipeline with strict separation of concerns:","\n",(0,l.jsxs)(i.ol,{children:["\n",(0,l.jsx)(i.li,{children:"ingest (CSV/DB) \u2192 raw JSON"}),"\n",(0,l.jsx)(i.li,{children:"normalize-link \u2192 merge, dedup, link replies/tapbacks, validate"}),"\n",(0,l.jsx)(i.li,{children:"enrich-ai \u2192 AI-only augmentation, idempotent and resumable"}),"\n",(0,l.jsx)(i.li,{children:"render-markdown \u2192 deterministic daily markdown, no network calls"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"3-data-model--invariants",children:"3. data model & invariants"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Single ",(0,l.jsx)(i.code,{children:"Message"})," model with\n",(0,l.jsx)(i.code,{children:"messageKind \u2208 {'text','media','tapback','notification'}"})]}),"\n",(0,l.jsxs)(i.li,{children:["Media is a standalone message with a single ",(0,l.jsx)(i.code,{children:"media"})," payload"]}),"\n",(0,l.jsxs)(i.li,{children:["Timestamps are ISO 8601 UTC with ",(0,l.jsx)(i.code,{children:"Z"})]}),"\n",(0,l.jsxs)(i.li,{children:["DB rows may be split into parts with stable part GUIDs ",(0,l.jsx)(i.code,{children:"p:<index>/<guid>"})]}),"\n",(0,l.jsx)(i.li,{children:"Linking uses canonical GUIDs and heuristics (see report)"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"schema",children:"schema"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Implement with TypeScript interfaces and Zod validators"}),"\n",(0,l.jsxs)(i.li,{children:["Use ",(0,l.jsx)(i.code,{children:"superRefine"})," for cross-field invariants"]}),"\n",(0,l.jsxs)(i.li,{children:["Enrichment is stored under ",(0,l.jsx)(i.code,{children:"message.media.enrichment: Array<MediaEnrichment>"})]}),"\n",(0,l.jsxs)(i.li,{children:["See report for the full schema block (copy to ",(0,l.jsx)(i.code,{children:"src/schema/message.ts"}),")"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"key-invariants",children:"key invariants"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["If ",(0,l.jsx)(i.code,{children:"messageKind = 'media'"})," \u2192 ",(0,l.jsx)(i.code,{children:"media"})," exists and is complete"]}),"\n",(0,l.jsxs)(i.li,{children:["If ",(0,l.jsx)(i.code,{children:"messageKind = 'tapback'"})," \u2192 ",(0,l.jsx)(i.code,{children:"tapback"})," exists"]}),"\n",(0,l.jsxs)(i.li,{children:["Non-media messages must not carry a ",(0,l.jsx)(i.code,{children:"media"})," payload"]}),"\n",(0,l.jsxs)(i.li,{children:["All dates are ISO 8601 with ",(0,l.jsx)(i.code,{children:"Z"})]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.code,{children:"media.path"})," must be absolute when available; missing files retain filename"]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"4-components--clis",children:"4. components & CLIs"}),"\n",(0,l.jsx)(i.h3,{id:"41-ingest-csv",children:"4.1 ingest-csv"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Input: iMazing CSV export + attachments dir"}),"\n",(0,l.jsxs)(i.li,{children:["Output: ",(0,l.jsx)(i.code,{children:"messages.csv.ingested.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Responsibilities:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Parse rows, split into text/media/tapback/notification"}),"\n",(0,l.jsx)(i.li,{children:"Resolve media paths (iMazing pattern) to absolute paths when possible"}),"\n",(0,l.jsx)(i.li,{children:"Emit minimal linking info; do not perform cross-row linking"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"42-ingest-db",children:"4.2 ingest-db"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Input: Messages.app SQLite DB + attachments roots"}),"\n",(0,l.jsxs)(i.li,{children:["Output: ",(0,l.jsx)(i.code,{children:"messages.db.ingested.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Responsibilities:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Extract messages, attachments, tapback hints"}),"\n",(0,l.jsx)(i.li,{children:"Do not split rows; keep attachments at this stage or split minimally"}),"\n",(0,l.jsx)(i.li,{children:"Preserve row metadata for later splitting"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"43-normalize-link",children:"4.3 normalize-link"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Input: one or both ingests"}),"\n",(0,l.jsxs)(i.li,{children:["Output: ",(0,l.jsx)(i.code,{children:"messages.normalized.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Responsibilities:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Merge sources, dedup by GUID + content equivalence"}),"\n",(0,l.jsxs)(i.li,{children:["Split DB rows into parts with ",(0,l.jsx)(i.code,{children:"messageKind"})," per part"]}),"\n",(0,l.jsxs)(i.li,{children:["Assign part GUIDs ",(0,l.jsx)(i.code,{children:"p:<index>/<guid>"})," for media and tapbacks"]}),"\n",(0,l.jsx)(i.li,{children:"Link replies/tapbacks (DB association first, then heuristics)"}),"\n",(0,l.jsx)(i.li,{children:"Enforce schema via Zod; fix camelCase and standardize fields"}),"\n",(0,l.jsx)(i.li,{children:"Validate date correctness and path absolutes"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"44-enrich-ai",children:"4.4 enrich-ai"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Input: ",(0,l.jsx)(i.code,{children:"messages.normalized.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Output: ",(0,l.jsx)(i.code,{children:"messages.enriched.json"})," + per-run checkpoint + optional\n",(0,l.jsx)(i.code,{children:"messages.full-descriptions.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Responsibilities:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Image analysis (HEIC/TIFF\u2192JPG preview + Gemini caption/summary)"}),"\n",(0,l.jsx)(i.li,{children:"Audio transcription with structured prompt and short description"}),"\n",(0,l.jsx)(i.li,{children:"PDF summarization; video copied with note, no heavy analysis by default"}),"\n",(0,l.jsx)(i.li,{children:"Link context via Firecrawl; resilient fallbacks (YouTube/Spotify/etc.)"}),"\n",(0,l.jsxs)(i.li,{children:["Idempotent enrichment keyed by ",(0,l.jsx)(i.code,{children:"media.id"})," + ",(0,l.jsx)(i.code,{children:"kind"})]}),"\n",(0,l.jsx)(i.li,{children:"Checkpointing, rate limits, retries; resumable execution"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"45-render-markdown",children:"4.5 render-markdown"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Input: ",(0,l.jsx)(i.code,{children:"messages.enriched.json"})]}),"\n",(0,l.jsxs)(i.li,{children:["Output: per-day Markdown files under ",(0,l.jsx)(i.code,{children:"outputDir"})]}),"\n",(0,l.jsxs)(i.li,{children:["Responsibilities:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Group by date and time-of-day (Morning/Afternoon/Evening)"}),"\n",(0,l.jsx)(i.li,{children:"Message anchors for deep links; nested replies/tapbacks"}),"\n",(0,l.jsx)(i.li,{children:"Obsidian-friendly embeds for images (use preview for HEIC/TIFF)"}),"\n",(0,l.jsx)(i.li,{children:"Quote transcriptions and link contexts as blockquotes"}),"\n",(0,l.jsx)(i.li,{children:"Strictly deterministic; no network calls"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"5-configuration",children:"5. configuration"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Central ",(0,l.jsx)(i.code,{children:"./.scripts/config/pipeline.config.json"})," with:","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Ingest paths, attachments roots"}),"\n",(0,l.jsx)(i.li,{children:"Normalize-link toggles (heuristics, thresholds)"}),"\n",(0,l.jsxs)(i.li,{children:["Enrich toggles: ",(0,l.jsx)(i.code,{children:"enableVisionAnalysis"}),", ",(0,l.jsx)(i.code,{children:"enableLinkAnalysis"}),", ",(0,l.jsx)(i.code,{children:"geminiModel"}),",\n",(0,l.jsx)(i.code,{children:"rateLimitDelay"}),", ",(0,l.jsx)(i.code,{children:"checkpointInterval"}),", ",(0,l.jsx)(i.code,{children:"maxRetries"})]}),"\n",(0,l.jsx)(i.li,{children:"Render options: output dir, naming, sectioning"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(i.li,{children:["Env var expansion supported using ",(0,l.jsx)(i.code,{children:"${VAR}"})," syntax"]}),"\n",(0,l.jsx)(i.li,{children:"API keys only from env; never persisted to artifacts/checkpoints"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"6-logging-errors-resiliency",children:"6. logging, errors, resiliency"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Structured log lines with type, target, and result"}),"\n",(0,l.jsxs)(i.li,{children:["Centralized retry/backoff for 429/5xx with jitter; respect ",(0,l.jsx)(i.code,{children:"rateLimitDelay"})]}),"\n",(0,l.jsx)(i.li,{children:"Checkpoint schema: last index, partial outputs, stats, failed items"}),"\n",(0,l.jsx)(i.li,{children:"On resume, verify config consistency before continuing"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"7-security--privacy",children:"7. security & privacy"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Local-only mode (skip enrichment calls)"}),"\n",(0,l.jsx)(i.li,{children:"Redaction hooks (optional) before writing enriched JSON/Markdown"}),"\n",(0,l.jsx)(i.li,{children:"Avoid persisting API keys; scrub logs of sensitive content"}),"\n",(0,l.jsx)(i.li,{children:"Provenance on enrichment entries: provider, model, version, timestamp"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"8-performance",children:"8. performance"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Concurrency caps tuned by provider rate limits"}),"\n",(0,l.jsx)(i.li,{children:"Batch writes with atomic temp-file swap"}),"\n",(0,l.jsx)(i.li,{children:"HEIC/TIFF preview generation only once per file (cache by filename)"}),"\n",(0,l.jsx)(i.li,{children:"Enable per-day rendering to limit memory footprint"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"9-testing--ci",children:"9. testing & CI"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Vitest with ",(0,l.jsx)(i.code,{children:"threads"})," pool, cap \u2264 8 workers, ",(0,l.jsx)(i.code,{children:"allowOnly: false"})]}),"\n",(0,l.jsxs)(i.li,{children:["Coverage with ",(0,l.jsx)(i.code,{children:"@vitest/coverage-v8"}),", thresholds \u2265 70% branches"]}),"\n",(0,l.jsxs)(i.li,{children:["Use ",(0,l.jsx)(i.code,{children:"jsdom"})," for renderer-related tests"]}),"\n",(0,l.jsxs)(i.li,{children:["Place tests in ",(0,l.jsx)(i.code,{children:"__tests__/"})," or ",(0,l.jsx)(i.code,{children:"*.test.ts"}),"/",(0,l.jsx)(i.code,{children:"*.test.tsx"})]}),"\n",(0,l.jsxs)(i.li,{children:["Global setup via ",(0,l.jsx)(i.code,{children:"./tests/vitest/vitest-setup.ts"})]}),"\n",(0,l.jsxs)(i.li,{children:["Respect Vite aliases like ",(0,l.jsx)(i.code,{children:"#lib"}),", ",(0,l.jsx)(i.code,{children:"#components"})," if present"]}),"\n",(0,l.jsxs)(i.li,{children:["CI (detected via ",(0,l.jsx)(i.code,{children:"TF_BUILD"}),"):","\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Output JUnit to ",(0,l.jsx)(i.code,{children:"./test-results/junit.xml"})]}),"\n",(0,l.jsxs)(i.li,{children:["Coverage to ",(0,l.jsx)(i.code,{children:"./test-results/coverage/"})," with ",(0,l.jsx)(i.code,{children:"junit"}),", ",(0,l.jsx)(i.code,{children:"html"}),", ",(0,l.jsx)(i.code,{children:"text-summary"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"test-areas",children:"test areas"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Schema validation: happy path + invariants violations"}),"\n",(0,l.jsx)(i.li,{children:"Normalize-link: DB split to parts, part GUIDs, reply/tapback linking parity"}),"\n",(0,l.jsx)(i.li,{children:"Enrich-ai: image\u2192preview, audio transcription prompt, link fallbacks"}),"\n",(0,l.jsx)(i.li,{children:"Render-markdown: deterministic snapshot outputs given fixed input"}),"\n",(0,l.jsxs)(i.li,{children:["Date handling: CSV UTC and DB Apple epoch \u2192 ISO ",(0,l.jsx)(i.code,{children:"Z"})," round-trip"]}),"\n",(0,l.jsx)(i.li,{children:"Path resolution: absolute paths required; provenance retained"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"10-migration-plan",children:"10. migration plan"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["Phase 1: Extract schema to ",(0,l.jsx)(i.code,{children:"src/schema/message.ts"})," with Zod"]}),"\n",(0,l.jsxs)(i.li,{children:["Phase 2: Build ",(0,l.jsx)(i.code,{children:"normalize-link"})," and validate CSV ingest output"]}),"\n",(0,l.jsx)(i.li,{children:"Phase 3: Add DB ingest alignment; split rows and part GUIDs"}),"\n",(0,l.jsxs)(i.li,{children:["Phase 4: Extract ",(0,l.jsx)(i.code,{children:"enrich-ai"}),"; preserve checkpoints and stats"]}),"\n",(0,l.jsxs)(i.li,{children:["Phase 5: Extract ",(0,l.jsx)(i.code,{children:"render-markdown"}),"; maintain output layout"]}),"\n",(0,l.jsx)(i.li,{children:"Phase 6: Wire CI, coverage, snapshots, and validator CLI"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"11-task-decomposition",children:"11. task decomposition"}),"\n",(0,l.jsx)(i.h3,{id:"epics",children:"epics"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"E1: Unified schema + validator"}),"\n",(0,l.jsx)(i.li,{children:"E2: Normalize-link implementation"}),"\n",(0,l.jsx)(i.li,{children:"E3: Enrich-ai extraction and hardening"}),"\n",(0,l.jsx)(i.li,{children:"E4: Render-markdown extraction and parity"}),"\n",(0,l.jsx)(i.li,{children:"E5: CI/test coverage and tooling"}),"\n",(0,l.jsx)(i.li,{children:"E6: Docs and migration"}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"detailed-tasks",children:"detailed tasks"}),"\n",(0,l.jsx)(i.p,{children:"E1 \u2014 schema & validator"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["T1.1 Create ",(0,l.jsx)(i.code,{children:"src/schema/message.ts"})," with types and Zod"]}),"\n",(0,l.jsxs)(i.li,{children:["T1.2 Implement ",(0,l.jsx)(i.code,{children:"scripts/validate-json.mts"})," to validate artifacts"]}),"\n",(0,l.jsx)(i.li,{children:"T1.3 Add fixtures and unit tests for schema invariants"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"E2 \u2014 normalize-link"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"T2.1 Implement CSV\u2192schema mapping"}),"\n",(0,l.jsxs)(i.li,{children:["T2.2 Implement DB row split into parts with ",(0,l.jsx)(i.code,{children:"p:<index>/<guid>"})]}),"\n",(0,l.jsx)(i.li,{children:"T2.3 Implement reply/tapback linking (DB association first)"}),"\n",(0,l.jsx)(i.li,{children:"T2.4 Dedup across CSV/DB; prefer DB for authoritative fields"}),"\n",(0,l.jsx)(i.li,{children:"T2.5 Absolute path enforcement and provenance stamping"}),"\n",(0,l.jsxs)(i.li,{children:["T2.6 Date validator (ISO ",(0,l.jsx)(i.code,{children:"Z"}),") and Apple epoch conversion checks"]}),"\n",(0,l.jsx)(i.li,{children:"T2.7 Zod validation + error reporting"}),"\n",(0,l.jsx)(i.li,{children:"T2.8 Tests: split, linking parity, dedup, dates, paths"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"E3 \u2014 enrich-ai"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"T3.1 Port image analysis + preview creation"}),"\n",(0,l.jsx)(i.li,{children:"T3.2 Port audio transcription prompt and parsers"}),"\n",(0,l.jsx)(i.li,{children:"T3.3 Port PDF summary and video handling"}),"\n",(0,l.jsx)(i.li,{children:"T3.4 Port link enrichment with fallbacks; add provider stubs for tests"}),"\n",(0,l.jsxs)(i.li,{children:["T3.5 Implement idempotency by ",(0,l.jsx)(i.code,{children:"media.id"})," + ",(0,l.jsx)(i.code,{children:"kind"})]}),"\n",(0,l.jsx)(i.li,{children:"T3.6 Checkpointing and resume logic (atomic writes)"}),"\n",(0,l.jsx)(i.li,{children:"T3.7 Rate limiting and retry policy with jitter"}),"\n",(0,l.jsx)(i.li,{children:"T3.8 Tests: enrichment idempotency, rate limit gates, checkpoints"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"E4 \u2014 render-markdown"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"T4.1 Port grouping (date/time-of-day) and anchors"}),"\n",(0,l.jsx)(i.li,{children:"T4.2 Render nested replies/tapbacks; emoji mapping"}),"\n",(0,l.jsx)(i.li,{children:"T4.3 Embed images with previews; quote transcripts and link context"}),"\n",(0,l.jsx)(i.li,{children:"T4.4 Determinism tests with snapshots; no network calls"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"E5 \u2014 CI/tests/tooling"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"T5.1 Vitest config (threads \u2264 8, jsdom where needed)"}),"\n",(0,l.jsx)(i.li,{children:"T5.2 Coverage V8 with thresholds; CI reporters and outputs"}),"\n",(0,l.jsxs)(i.li,{children:["T5.3 Setup tests runner scripts in ",(0,l.jsx)(i.code,{children:"package.json"})," (pnpm)"]}),"\n",(0,l.jsxs)(i.li,{children:["T5.4 Add ",(0,l.jsx)(i.code,{children:"renderWithProviders"})," test helper (if React involved later)"]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"E6 \u2014 docs & migration"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"T6.1 Update refactor report with any deltas from impl"}),"\n",(0,l.jsx)(i.li,{children:"T6.2 Usage docs: how to run each stage and E2E"}),"\n",(0,l.jsx)(i.li,{children:"T6.3 Troubleshooting: dates, paths, missing media, rate limits"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"12-acceptance-criteria",children:"12. acceptance criteria"}),"\n",(0,l.jsx)(i.p,{children:"Global"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["A1. All produced dates are ISO 8601 with ",(0,l.jsx)(i.code,{children:"Z"})]}),"\n",(0,l.jsx)(i.li,{children:"A2. All media paths in normalized and enriched outputs are absolute when files\nexist; missing files retain filename with provenance"}),"\n",(0,l.jsxs)(i.li,{children:["A3. Schema validation passes (",(0,l.jsx)(i.code,{children:"validate-json"}),") for all artifacts"]}),"\n",(0,l.jsxs)(i.li,{children:["A4. CI runs Vitest with ",(0,l.jsx)(i.code,{children:"allowOnly: false"}),", producing JUnit + coverage"]}),"\n",(0,l.jsx)(i.li,{children:"A5. Coverage thresholds met (\u2265 70% branches global)"}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Normalize-link"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["N1. DB messages with ",(0,l.jsx)(i.code,{children:"n"})," attachments become 1 text + ",(0,l.jsx)(i.code,{children:"n"})," media messages, each\nwith stable part GUIDs ",(0,l.jsx)(i.code,{children:"p:<index>/<guid>"})]}),"\n",(0,l.jsx)(i.li,{children:"N2. Replies/tapbacks link to the correct parent GUIDs; parity with CSV rules"}),"\n",(0,l.jsx)(i.li,{children:"N3. Dedup merges CSV/DB without losing data; GUID stability retained"}),"\n",(0,l.jsx)(i.li,{children:"N4. Paths are absolute and dated filename rules are enforced"}),"\n",(0,l.jsxs)(i.li,{children:["N5. Dates from CSV and DB align to UTC ISO ",(0,l.jsx)(i.code,{children:"Z"})]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Enrich-ai"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"E1. Image HEIC/TIFF produce a JPG preview once and reuse it"}),"\n",(0,l.jsxs)(i.li,{children:["E2. Audio transcription includes timestamps, speaker labels, and a short\ndescription; stored under ",(0,l.jsx)(i.code,{children:"media.enrichment"})]}),"\n",(0,l.jsx)(i.li,{children:"E3. Link context uses Firecrawl when possible; falls back to YouTube/Spotify/\nsocial heuristics; never crashes the run"}),"\n",(0,l.jsxs)(i.li,{children:["E4. Idempotency: re-running enrich does not duplicate entries for the same\n",(0,l.jsx)(i.code,{children:"media.id"})," + ",(0,l.jsx)(i.code,{children:"kind"})]}),"\n",(0,l.jsxs)(i.li,{children:["E5. Checkpointing: ",(0,l.jsx)(i.code,{children:"--resume"})," restarts within \u2264 1 item of prior state"]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Render-markdown"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:["R1. Output is deterministic for a fixed ",(0,l.jsx)(i.code,{children:"messages.enriched.json"})]}),"\n",(0,l.jsx)(i.li,{children:"R2. Sections grouped by Morning/Afternoon/Evening with deep-link anchors"}),"\n",(0,l.jsx)(i.li,{children:"R3. Replies/tapbacks rendered as nested quotes; emoji reactions map as\ndocumented"}),"\n",(0,l.jsx)(i.li,{children:"R4. Embeds prefer previews for HEIC/TIFF and link to original where relevant"}),"\n",(0,l.jsx)(i.li,{children:"R5. Link contexts and transcriptions appear as blockquotes under the message"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"13-risks--mitigations",children:"13. risks & mitigations"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"Rate limits and API changes \u2192 implement jittered retries and provider\nabstraction; local-only mode fallback"}),"\n",(0,l.jsx)(i.li,{children:"Missing or moved attachments \u2192 absolute path enforcement, provenance, and\nwarnings with counters"}),"\n",(0,l.jsx)(i.li,{children:"Timezone drift and date bugs \u2192 end-to-end date validator and fixtures"}),"\n",(0,l.jsx)(i.li,{children:"Heuristic linking ambiguity \u2192 prefer DB associations; log ties and expose\nreview tooling"}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"14-milestones",children:"14. milestones"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsx)(i.li,{children:"M1: Schema + validator + fixtures"}),"\n",(0,l.jsx)(i.li,{children:"M2: Normalize-link with CSV parity and tests"}),"\n",(0,l.jsx)(i.li,{children:"M3: DB split + linking parity + dates/paths validator"}),"\n",(0,l.jsx)(i.li,{children:"M4: Enrich-ai extraction with checkpoints and idempotency"}),"\n",(0,l.jsx)(i.li,{children:"M5: Render-markdown deterministic parity with snapshots"}),"\n",(0,l.jsx)(i.li,{children:"M6: CI green with coverage, docs finalized"}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,l.jsx)(i,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},5705:(e,i,n)=>{n.d(i,{R:()=>t,x:()=>d});var s=n(7701);const l={},r=s.createContext(l);function t(e){const i=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function d(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),s.createElement(r.Provider,{value:i},e.children)}}}]);