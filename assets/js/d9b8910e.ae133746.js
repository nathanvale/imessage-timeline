"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[9835],{583:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"vitest-firecrawl-esm-bun-best-practices","title":"Vitest + Firecrawl ESM & Bun Best Practices for CLI Projects","description":"Research Date: 11 November 2025","source":"@site/docs/vitest-firecrawl-esm-bun-best-practices.md","sourceDirName":".","slug":"/vitest-firecrawl-esm-bun-best-practices","permalink":"/chatline/docs/vitest-firecrawl-esm-bun-best-practices","draft":false,"unlisted":false,"editUrl":"https://github.com/nathanvale/chatline/tree/main/website/docs/vitest-firecrawl-esm-bun-best-practices.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Testing best practices (Vitest + Testing Library + Wallaby)","permalink":"/chatline/docs/testing-best-practices"}}');var r=s(6801),t=s(5705);const c={},l="Vitest + Firecrawl ESM & Bun Best Practices for CLI Projects",o={},a=[{value:"Executive Summary",id:"executive-summary",level:2},{value:"1. Vitest Configuration Best Practices",id:"1-vitest-configuration-best-practices",level:2},{value:"1.1 Current Setup Analysis",id:"11-current-setup-analysis",level:3},{value:"1.2 ESM Module Best Practices",id:"12-esm-module-best-practices",level:3},{value:"1.3 Projects Configuration (Optional Enhancement)",id:"13-projects-configuration-optional-enhancement",level:3},{value:"2. Bun Integration Best Practices",id:"2-bun-integration-best-practices",level:2},{value:"2.1 Current Approach (\u2705 Correct)",id:"21-current-approach--correct",level:3},{value:"2.2 Vitest + Bun Considerations",id:"22-vitest--bun-considerations",level:3},{value:"2.3 Path Alias Resolution",id:"23-path-alias-resolution",level:3},{value:"3. Firecrawl SDK Integration",id:"3-firecrawl-sdk-integration",level:2},{value:"3.1 SDK Installation &amp; ESM Compatibility",id:"31-sdk-installation--esm-compatibility",level:3},{value:"3.2 Usage Patterns for CLI Tools",id:"32-usage-patterns-for-cli-tools",level:3},{value:"3.3 Testing Firecrawl Integration",id:"33-testing-firecrawl-integration",level:3},{value:"4. CLI-Specific Testing Patterns",id:"4-cli-specific-testing-patterns",level:2},{value:"4.1 CLI Command Testing",id:"41-cli-command-testing",level:3},{value:"4.2 File System Testing",id:"42-file-system-testing",level:3},{value:"4.3 Environment Variable Testing",id:"43-environment-variable-testing",level:3},{value:"5. Coverage &amp; CI Best Practices",id:"5-coverage--ci-best-practices",level:2},{value:"5.1 Current Coverage Config (\u2705 Strong)",id:"51-current-coverage-config--strong",level:3},{value:"5.2 CI-Specific Enhancements",id:"52-ci-specific-enhancements",level:3},{value:"6. Recommendations &amp; Action Items",id:"6-recommendations--action-items",level:2},{value:"6.1 Keep Current (\u2705 No changes needed)",id:"61-keep-current--no-changes-needed",level:3},{value:"6.2 Optional Enhancements",id:"62-optional-enhancements",level:3},{value:"A. Remove <code>globals: true</code> (modern Vitest pattern)",id:"a-remove-globals-true-modern-vitest-pattern",level:4},{value:"B. Add <code>projects</code> for unit vs integration split (optional)",id:"b-add-projects-for-unit-vs-integration-split-optional",level:4},{value:"C. Add Firecrawl integration test suite",id:"c-add-firecrawl-integration-test-suite",level:4},{value:"7. Common Issues &amp; Solutions",id:"7-common-issues--solutions",level:2},{value:"Issue 1: ESM import errors in tests",id:"issue-1-esm-import-errors-in-tests",level:3},{value:"Issue 2: Path aliases not resolving",id:"issue-2-path-aliases-not-resolving",level:3},{value:"Issue 3: Firecrawl SDK timeout in tests",id:"issue-3-firecrawl-sdk-timeout-in-tests",level:3},{value:"8. References",id:"8-references",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"vitest--firecrawl-esm--bun-best-practices-for-cli-projects",children:"Vitest + Firecrawl ESM & Bun Best Practices for CLI Projects"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Research Date:"})," 11 November 2025",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Sources:"})," Context7 (Vitest & Firecrawl official docs)",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Project Type:"})," TypeScript CLI tool with ESM modules"]}),"\n",(0,r.jsx)(n.h2,{id:"executive-summary",children:"Executive Summary"}),"\n",(0,r.jsx)(n.p,{children:"This document provides authoritative best practices for configuring Vitest in an\nESM-based CLI project that uses Bun for development and Firecrawl SDK\nintegration. Key findings:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Current setup is solid"})," \u2014 Single-project Vitest config with proper ESM\nalias support"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bun for dev, Node for tests"})," \u2014 Correct separation (Bun runtime for CLI,\nVitest on Node for stability)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Firecrawl SDK is ESM-ready"})," \u2014 ",(0,r.jsx)(n.code,{children:"@mendable/firecrawl-js"})," works with Node.js\nESM and Bun"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"jsdom v25"})," \u2014 Downgraded from v27 to avoid parse5 ESM/CJS issues (\u2705\nresolved)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-vitest-configuration-best-practices",children:"1. Vitest Configuration Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"11-current-setup-analysis",children:"1.1 Current Setup Analysis"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// vitest.config.ts (current)\nexport default defineConfig({\n  resolve: {\n    alias: {\n      '#schema': resolve(__dirname, './src/schema'),\n      // ... other path aliases\n    },\n  },\n  test: {\n    environment: 'jsdom',\n    pool: 'threads',\n    isolate: true,\n    globals: true,\n    setupFiles: ['./tests/vitest/vitest-setup.ts'],\n    // ... coverage, reporters\n  },\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u2705 What's working well:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Path aliases correctly mirror ",(0,r.jsx)(n.code,{children:"package.json"})," imports field"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pool: 'threads'"})," with ",(0,r.jsx)(n.code,{children:"maxThreads: 8"})," \u2014 optimal for CI and local"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"isolate: true"})," \u2014 prevents test state leakage (recommended for CLI tools)"]}),"\n",(0,r.jsxs)(n.li,{children:["Coverage thresholds enforced with ",(0,r.jsx)(n.code,{children:"perFile: true"})]}),"\n",(0,r.jsx)(n.li,{children:"Conditional CI reporters (JUnit + coverage)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u26a0\ufe0f Considerations:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No projects array \u2014 fine for single-environment testing"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"globals: true"})," \u2014 convenient but discouraged in modern Vitest (prefer explicit\nimports)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"12-esm-module-best-practices",children:"1.2 ESM Module Best Practices"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"From Vitest docs:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Always use ",(0,r.jsx)(n.code,{children:"import.meta.url"})," for path resolution in ESM:"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// \u2705 Correct (ESM-safe)\nalias: {\n  '@/': new URL('./src/', import.meta.url).pathname\n}\n\n// \u274c Avoid __dirname (requires polyfill in pure ESM)\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["For CLI projects, avoid ",(0,r.jsx)(n.code,{children:"globals: true"}),":"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Preferred modern approach\nimport { describe, it, expect } from 'vitest'\n\ndescribe('my test', () => {\n  it('should work', () => {\n    expect(1).toBe(1)\n  })\n})\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"defineConfig"})," from 'vitest/config' (not 'vite'):"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Already correct in current setup \u2705"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"13-projects-configuration-optional-enhancement",children:"1.3 Projects Configuration (Optional Enhancement)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["When to use ",(0,r.jsx)(n.code,{children:"projects"}),":"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Separate unit vs integration tests"}),"\n",(0,r.jsx)(n.li,{children:"Different environments (node vs jsdom)"}),"\n",(0,r.jsx)(n.li,{children:"Parallel test execution with distinct configs"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example for CLI tool:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export default defineConfig({\n  test: {\n    projects: [\n      {\n        name: 'unit',\n        isolate: false, // Faster for pure unit tests\n        include: ['src/**/*.test.ts'],\n        exclude: ['**/*.integration.test.ts'],\n        environment: 'node', // CLI doesn't need jsdom\n      },\n      {\n        name: 'integration',\n        include: ['**/*.integration.test.ts'],\n        environment: 'jsdom', // If testing HTML/DOM scenarios\n        testTimeout: 30000,\n      },\n    ],\n  },\n})\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"For this project:"})," Current single-config approach is fine unless you need:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Separate timeouts for slow integration tests"}),"\n",(0,r.jsx)(n.li,{children:"Different reporters per test type"}),"\n",(0,r.jsx)(n.li,{children:"Parallel execution of unit vs integration"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-bun-integration-best-practices",children:"2. Bun Integration Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"21-current-approach--correct",children:"2.1 Current Approach (\u2705 Correct)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Development (Bun):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "dev": "bun src/cli.ts",\n  "validate:json": "bun scripts/validate-json.ts"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Testing (Node/Vitest):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "test": "vitest run",\n  "test:watch": "vitest"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Why this works:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Bun excels at fast TypeScript execution (dev inner loop)"}),"\n",(0,r.jsx)(n.li,{children:"Vitest on Node ensures deterministic test environment (CI stability)"}),"\n",(0,r.jsx)(n.li,{children:"Native addons (sharp, better-sqlite3) work predictably on Node"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"22-vitest--bun-considerations",children:"2.2 Vitest + Bun Considerations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"From Vitest docs:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Vitest can run under Bun (",(0,r.jsx)(n.code,{children:"bunx vitest"}),") but it's experimental"]}),"\n",(0,r.jsxs)(n.li,{children:["Pool options (",(0,r.jsx)(n.code,{children:"threads"}),", ",(0,r.jsx)(n.code,{children:"forks"}),") behave differently under Bun"]}),"\n",(0,r.jsx)(n.li,{children:"Coverage with V8 provider requires Node runtime"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Recommendation:"})," Keep tests on Node (current setup \u2705)"]}),"\n",(0,r.jsx)(n.h3,{id:"23-path-alias-resolution",children:"2.3 Path Alias Resolution"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Current aliases work because:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"vitest.config.ts"})," mirrors ",(0,r.jsx)(n.code,{children:"package.json"})," imports"]}),"\n",(0,r.jsxs)(n.li,{children:["Both Bun and Vitest resolve ",(0,r.jsx)(n.code,{children:"#schema/*"})," correctly"]}),"\n",(0,r.jsxs)(n.li,{children:["No need for ",(0,r.jsx)(n.code,{children:"tsconfig-paths"})," plugin (aliases in Vite config handle it)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["If using ",(0,r.jsx)(n.code,{children:"baseUrl"})," in tsconfig:"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Would need this plugin\nimport tsconfigPaths from 'vite-tsconfig-paths'\n\nexport default defineConfig({\n  plugins: [tsconfigPaths()], // Resolves tsconfig baseUrl/paths\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"Not needed for this project (using imports field \u2705)"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-firecrawl-sdk-integration",children:"3. Firecrawl SDK Integration"}),"\n",(0,r.jsx)(n.h3,{id:"31-sdk-installation--esm-compatibility",children:"3.1 SDK Installation & ESM Compatibility"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Current SDK:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "dependencies": {\n    "@mendable/firecrawl-js": "^4.3.7"\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 ESM-ready:"})," Package exports ESM and works with:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Node.js with ",(0,r.jsx)(n.code,{children:'"type": "module"'})]}),"\n",(0,r.jsx)(n.li,{children:"Bun runtime"}),"\n",(0,r.jsxs)(n.li,{children:["TypeScript with ",(0,r.jsx)(n.code,{children:'moduleResolution: "bundler"'})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"32-usage-patterns-for-cli-tools",children:"3.2 Usage Patterns for CLI Tools"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Initialization (Node/Bun compatible):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import Firecrawl from '@mendable/firecrawl-js'\n\nconst app = new Firecrawl({\n  apiKey: process.env.FIRECRAWL_API_KEY || '',\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scraping:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const doc = await app.scrape('https://example.com', {\n  formats: ['markdown', 'html'],\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Crawling (async with status checks):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Start crawl\nconst crawl = await app.startCrawl('https://example.com', {\n  limit: 100,\n  scrapeOptions: { formats: ['markdown'] },\n})\n\n// Check status\nconst status = await app.getCrawlStatus(crawl.id)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Extract structured data (with Zod):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { z } from 'zod'\n\nconst schema = z.object({\n  title: z.string(),\n  content: z.string(),\n})\n\nconst result = await app.extract({\n  urls: ['https://example.com'],\n  schema,\n  prompt: 'Extract title and content',\n})\n"})}),"\n",(0,r.jsx)(n.h3,{id:"33-testing-firecrawl-integration",children:"3.3 Testing Firecrawl Integration"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Mock approach in tests:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { vi } from 'vitest'\nimport Firecrawl from '@mendable/firecrawl-js'\n\nvi.mock('@mendable/firecrawl-js')\n\ndescribe('link enrichment', () => {\n  it('should fetch link context', async () => {\n    const mockScrape = vi.fn().mockResolvedValue({\n      markdown: '# Test Content',\n    })\n\n    vi.mocked(Firecrawl).mockImplementation(() => ({\n      scrape: mockScrape,\n    }))\n\n    // Test your code that uses Firecrawl\n  })\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Real integration tests:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// tests/integration/firecrawl.integration.test.ts\nimport { describe, it, expect } from 'vitest'\nimport Firecrawl from '@mendable/firecrawl-js'\n\ndescribe('Firecrawl integration', { timeout: 30000 }, () => {\n  it('should scrape real URL', async () => {\n    const app = new Firecrawl({ apiKey: process.env.FIRECRAWL_API_KEY })\n    const result = await app.scrape('https://firecrawl.dev')\n\n    expect(result.markdown).toBeDefined()\n  })\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Conditional execution (CI vs local):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"describe.skipIf(!process.env.FIRECRAWL_API_KEY)('Firecrawl live tests', () => {\n  // Only runs if API key is set\n})\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-cli-specific-testing-patterns",children:"4. CLI-Specific Testing Patterns"}),"\n",(0,r.jsx)(n.h3,{id:"41-cli-command-testing",children:"4.1 CLI Command Testing"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Vitest approach for CLI tools:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { describe, it, expect, vi } from 'vitest'\nimport { Command } from 'commander'\n\ndescribe('CLI commands', () => {\n  it('should parse --help flag', async () => {\n    const program = new Command()\n    // Set up your CLI\n\n    const exitSpy = vi.spyOn(process, 'exit').mockImplementation()\n    const logSpy = vi.spyOn(console, 'log').mockImplementation()\n\n    await program.parseAsync(['node', 'cli.js', '--help'])\n\n    expect(logSpy).toHaveBeenCalled()\n    expect(exitSpy).toHaveBeenCalledWith(0)\n  })\n})\n"})}),"\n",(0,r.jsx)(n.h3,{id:"42-file-system-testing",children:"4.2 File System Testing"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use memfs for deterministic FS tests:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { fs } from 'memfs'\nimport { vol } from 'memfs'\n\nvi.mock('fs')\nvi.mock('fs/promises')\n\nbeforeEach(() => {\n  vol.reset()\n  vol.fromJSON({\n    '/test/input.json': '{\"messages\": []}',\n  })\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Already set up in ",(0,r.jsx)(n.code,{children:"__mocks__/fs.cjs"})," \u2705"]})}),"\n",(0,r.jsx)(n.h3,{id:"43-environment-variable-testing",children:"4.3 Environment Variable Testing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { beforeEach, afterEach } from 'vitest'\n\nlet originalEnv: NodeJS.ProcessEnv\n\nbeforeEach(() => {\n  originalEnv = process.env\n  process.env = { ...originalEnv }\n})\n\nafterEach(() => {\n  process.env = originalEnv\n})\n\nit('should use API key from env', () => {\n  process.env.FIRECRAWL_API_KEY = 'test-key'\n  // Test code\n})\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-coverage--ci-best-practices",children:"5. Coverage & CI Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"51-current-coverage-config--strong",children:"5.1 Current Coverage Config (\u2705 Strong)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"coverage: {\n  provider: 'v8',         // Fastest, best for ESM\n  all: true,              // Track untested files\n  perFile: true,          // Enforce per-file thresholds\n  thresholds: {\n    branches: 75,\n    lines: 80,\n    functions: 80,\n    statements: 80,\n  },\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"52-ci-specific-enhancements",children:"5.2 CI-Specific Enhancements"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Conditional reporters:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"reporters: process.env.TF_BUILD\n  ? ['junit', 'default']\n  : ['default'],\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Parallel execution in CI:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"poolOptions: {\n  threads: {\n    maxThreads: process.env.CI ? 4 : 8, // Limit in CI\n    minThreads: 1,\n  },\n},\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fail fast for CI:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"test: {\n  bail: process.env.CI ? 1 : undefined, // Stop on first failure in CI\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-recommendations--action-items",children:"6. Recommendations & Action Items"}),"\n",(0,r.jsx)(n.h3,{id:"61-keep-current--no-changes-needed",children:"6.1 Keep Current (\u2705 No changes needed)"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Vitest on Node runtime"})," \u2014 stable, deterministic"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bun for CLI dev"})," \u2014 fast, TypeScript-native"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Path aliases"})," \u2014 working correctly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Coverage setup"})," \u2014 comprehensive"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"jsdom v25"})," \u2014 stable, no ESM issues"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"62-optional-enhancements",children:"6.2 Optional Enhancements"}),"\n",(0,r.jsxs)(n.h4,{id:"a-remove-globals-true-modern-vitest-pattern",children:["A. Remove ",(0,r.jsx)(n.code,{children:"globals: true"})," (modern Vitest pattern)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Before:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"test: {\n  globals: true,\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"After:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// vitest.config.ts\ntest: {\n  // Remove globals: true\n}\n\n// In test files\nimport { describe, it, expect, vi } from 'vitest'\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Explicit imports (better for tree-shaking)"}),"\n",(0,r.jsx)(n.li,{children:"No global pollution"}),"\n",(0,r.jsx)(n.li,{children:"TypeScript inference works better"}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"b-add-projects-for-unit-vs-integration-split-optional",children:["B. Add ",(0,r.jsx)(n.code,{children:"projects"})," for unit vs integration split (optional)"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"test: {\n  projects: [\n    {\n      name: 'unit',\n      isolate: false,\n      include: ['src/**/*.test.ts'],\n      exclude: ['**/*.integration.test.ts'],\n    },\n    {\n      name: 'integration',\n      include: ['**/*.integration.test.ts'],\n      testTimeout: 30000,\n    },\n  ],\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Run specific project:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pnpm test --project unit\npnpm test --project integration\n"})}),"\n",(0,r.jsx)(n.h4,{id:"c-add-firecrawl-integration-test-suite",children:"C. Add Firecrawl integration test suite"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Create:"})," ",(0,r.jsx)(n.code,{children:"tests/integration/firecrawl.integration.test.ts"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { describe, it, expect } from 'vitest'\nimport Firecrawl from '@mendable/firecrawl-js'\n\ndescribe.skipIf(!process.env.FIRECRAWL_API_KEY)(\n  'Firecrawl integration',\n  { timeout: 30000 },\n  () => {\n    const app = new Firecrawl({ apiKey: process.env.FIRECRAWL_API_KEY! })\n\n    it('should scrape real URL', async () => {\n      const result = await app.scrape('https://firecrawl.dev')\n      expect(result.markdown).toBeDefined()\n    })\n\n    it('should extract structured data', async () => {\n      const result = await app.extract({\n        urls: ['https://firecrawl.dev'],\n        prompt: 'Extract page title',\n        schema: { type: 'object', properties: { title: { type: 'string' } } },\n      })\n      expect(result.data).toBeDefined()\n    })\n  },\n)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Run:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"FIRECRAWL_API_KEY=fc-xxx pnpm test --project integration\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"7-common-issues--solutions",children:"7. Common Issues & Solutions"}),"\n",(0,r.jsx)(n.h3,{id:"issue-1-esm-import-errors-in-tests",children:"Issue 1: ESM import errors in tests"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptom:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Error: require() of ES Module not supported\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:'"type": "module"'})," in package.json \u2705 (current)"]}),"\n",(0,r.jsxs)(n.li,{children:["Use dynamic ",(0,r.jsx)(n.code,{children:"import()"})," for ESM-only packages"]}),"\n",(0,r.jsx)(n.li,{children:"Check jsdom version (v27 has parse5 ESM issues) \u2705 (fixed with v25)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"issue-2-path-aliases-not-resolving",children:"Issue 2: Path aliases not resolving"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptom:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Cannot find module '#schema/message'\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure aliases in ",(0,r.jsx)(n.code,{children:"vitest.config.ts"})," match ",(0,r.jsx)(n.code,{children:"package.json"})," imports \u2705"]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"resolve(__dirname, ...)"})," or ",(0,r.jsx)(n.code,{children:"new URL(..., import.meta.url).pathname"})]}),"\n",(0,r.jsxs)(n.li,{children:["Consider ",(0,r.jsx)(n.code,{children:"vite-tsconfig-paths"})," plugin if using ",(0,r.jsx)(n.code,{children:"baseUrl"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"issue-3-firecrawl-sdk-timeout-in-tests",children:"Issue 3: Firecrawl SDK timeout in tests"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptom:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Test timed out after 5000ms\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"describe('slow tests', { timeout: 30000 }, () => {\n  // ...\n})\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Or in ",(0,r.jsx)(n.code,{children:"vitest.config.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"test: {\n  testTimeout: 20000, // Already set \u2705\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"8-references",children:"8. References"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Vitest Documentation:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://vitest.dev/config/",children:"Vitest Config Reference"})," \u2014 Authoritative config\noptions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://vitest.dev/guide/migration.html",children:"ESM Projects"})," \u2014 ESM best practices"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://vitest.dev/guide/projects.html",children:"Projects Feature"})," \u2014 Multi-project\nsetup"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://vitest.dev/guide/coverage.html",children:"Coverage"})," \u2014 V8 provider setup"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Firecrawl Documentation:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mendableai/firecrawl/tree/main/apps/js-sdk/firecrawl",children:"Node.js SDK"}),"\n\u2014 Official SDK docs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://docs.firecrawl.dev/",children:"API Reference"})," \u2014 REST API endpoints"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mendableai/firecrawl/tree/main/examples",children:"Examples"})," \u2014\nIntegration patterns"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Bun Documentation:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://bun.sh/docs/cli/test",children:"Bun Test Runner"})," \u2014 Bun's native test runner"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://bun.sh/docs/runtime/nodejs-apis",children:"Bun vs Node"})," \u2014 Compatibility matrix"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsx)(n.p,{children:"Your current setup follows Vitest and Firecrawl best practices for ESM + CLI\nprojects:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Vitest on Node"})," \u2014 Stable, deterministic testing"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Bun for dev"})," \u2014 Fast TypeScript execution"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"ESM-first"})," \u2014 Proper module resolution"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Path aliases"})," \u2014 Correctly configured"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Coverage enforced"})," \u2014 V8 provider with thresholds"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Firecrawl SDK"})," \u2014 ESM-compatible, tested"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Optional improvements:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Remove ",(0,r.jsx)(n.code,{children:"globals: true"})," for modern explicit imports"]}),"\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.code,{children:"projects"})," array for unit/integration split"]}),"\n",(0,r.jsx)(n.li,{children:"Create Firecrawl integration test suite"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"No breaking changes needed"})," \u2014 current config is solid for a CLI tool with ESM\nmodules."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},5705:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>l});var i=s(7701);const r={},t=i.createContext(r);function c(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);